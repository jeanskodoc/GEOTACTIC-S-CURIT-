<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoHISTORY Pro - Système Cartographique Militaire</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        :root {
            --primary-color: #006400;
            --accent-color: #ff9800;
            --military-green: #228B22;
            --danger-red: #DC143C;
            --warning-yellow: #FFD700;
            --light-bg: #f5f7fa;
            --text-color: #333;
            --whatsapp-green: #25D366;
            --gps-blue: #0066FF;
            --tracking-orange: #FF5722;
            --route-color: #8B0000;
            --my-position-color: #FF00FF;
            --export-color: #9C27B0;
            --import-color: #2196F3;
            --satellite-color: #2E7D32;
            --topographic-color: #795548;
            --military-map-color: #4a6741;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Sidebar militaire */
        .main-sidebar {
            width: 280px;
            background: linear-gradient(180deg, #0a2f0a 0%, #1a5f1a 100%);
            color: white;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            border-right: 3px solid var(--accent-color);
        }
        
        .logo {
            padding: 12px;
            text-align: center;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--military-green) 100%);
        }
        
        .logo h1 {
            font-size: 1.2rem;
            margin-bottom: 3px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .logo .tagline {
            font-size: 0.7rem;
            opacity: 0.9;
            color: var(--accent-color);
            font-weight: bold;
        }
        
        .world-icon {
            font-size: 1.8rem;
            margin: 8px 0;
            color: var(--accent-color);
        }
        
        .tool-groups {
            padding: 10px;
            flex-grow: 1;
        }
        
        .tool-group {
            margin-bottom: 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 3px solid var(--accent-color);
        }
        
        .tool-group-title {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--accent-color);
            font-weight: bold;
        }
        
        .tool-buttons {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .tool-btn {
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 8px 10px;
            border-radius: 4px;
            text-align: left;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            line-height: 1.2;
            border: none;
        }
        
        .tool-btn:hover {
            background-color: rgba(255, 152, 0, 0.3);
            transform: translateX(4px);
            border-color: var(--accent-color);
        }
        
        .tool-btn.active {
            background-color: rgba(255, 152, 0, 0.4);
            border-color: var(--accent-color);
            font-weight: bold;
        }
        
        .tool-btn.military {
            background: linear-gradient(135deg, rgba(34, 139, 34, 0.2), rgba(139, 69, 19, 0.2));
            border-left: 3px solid var(--military-green);
        }
        
        .tool-btn.gps {
            background: linear-gradient(135deg, rgba(0, 102, 255, 0.2), rgba(0, 102, 255, 0.4));
            border-left: 3px solid var(--gps-blue);
        }
        
        .tool-btn.whatsapp {
            background: linear-gradient(135deg, rgba(37, 211, 102, 0.2), rgba(37, 211, 102, 0.4));
            border-left: 3px solid var(--whatsapp-green);
        }
        
        .tool-btn.tracking {
            background: linear-gradient(135deg, rgba(255, 87, 34, 0.2), rgba(255, 87, 34, 0.4));
            border-left: 3px solid var(--tracking-orange);
        }
        
        .tool-btn.route {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.2), rgba(139, 0, 0, 0.4));
            border-left: 3px solid var(--route-color);
        }
        
        .tool-btn.position {
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.2), rgba(255, 0, 255, 0.4));
            border-left: 3px solid var(--my-position-color);
        }
        
        .tool-btn.export {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.2), rgba(156, 39, 176, 0.4));
            border-left: 3px solid var(--export-color);
        }
        
        .tool-btn.import {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(33, 150, 243, 0.4));
            border-left: 3px solid var(--import-color);
        }
        
        .tool-btn.satellite {
            background: linear-gradient(135deg, rgba(46, 125, 50, 0.2), rgba(46, 125, 50, 0.4));
            border-left: 3px solid var(--satellite-color);
        }
        
        .tool-btn.topographic {
            background: linear-gradient(135deg, rgba(121, 85, 72, 0.2), rgba(121, 85, 72, 0.4));
            border-left: 3px solid var(--topographic-color);
        }
        
        .tool-btn.military-map {
            background: linear-gradient(135deg, rgba(74, 103, 65, 0.2), rgba(74, 103, 65, 0.4));
            border-left: 3px solid var(--military-map-color);
        }
        
        .tool-btn i {
            margin-right: 8px;
            width: 16px;
            text-align: center;
            font-size: 0.85rem;
        }
        
        /* Main content */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: linear-gradient(135deg, #e8f5e8 0%, #d4e6d4 100%);
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            background: linear-gradient(90deg, #0a2f0a 0%, var(--primary-color) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 10;
            min-height: 50px;
            border-bottom: 2px solid var(--accent-color);
        }
        
        .military-badge {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .fat-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #006400, #228B22);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            border: 2px solid var(--accent-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .search-container {
            position: relative;
            width: 300px;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 40px 8px 15px;
            border-radius: 20px;
            border: 2px solid var(--accent-color);
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
            width: 400px;
        }
        
        .search-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--accent-color);
            cursor: pointer;
            font-size: 1rem;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .search-results.active {
            display: block;
        }
        
        .search-result-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background-color 0.2s;
        }
        
        .search-result-item:hover {
            background-color: #f5f5f5;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .action-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .action-btn:hover {
            background-color: #ffad33;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .action-btn.military {
            background: linear-gradient(135deg, var(--military-green), #8B4513);
        }
        
        .action-btn.gps {
            background: linear-gradient(135deg, var(--gps-blue), #0044CC);
        }
        
        .action-btn.tracking {
            background: linear-gradient(135deg, var(--tracking-orange), #E64A19);
        }
        
        .action-btn.whatsapp {
            background: linear-gradient(135deg, var(--whatsapp-green), #128C7E);
        }
        
        .action-btn.route {
            background: linear-gradient(135deg, var(--route-color), #660000);
        }
        
        .action-btn.position {
            background: linear-gradient(135deg, var(--my-position-color), #CC00CC);
        }
        
        .action-btn.export {
            background: linear-gradient(135deg, var(--export-color), #7B1FA2);
        }
        
        .action-btn.import {
            background: linear-gradient(135deg, var(--import-color), #1976D2);
        }
        
        .action-btn.satellite {
            background: linear-gradient(135deg, var(--satellite-color), #1B5E20);
        }
        
        .action-btn.topographic {
            background: linear-gradient(135deg, var(--topographic-color), #5D4037);
        }
        
        .action-btn.military-map {
            background: linear-gradient(135deg, var(--military-map-color), #3a5531);
        }
        
        .location-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.8rem;
        }
        
        .location-status {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .location-status.active {
            color: var(--accent-color);
            background-color: rgba(255, 152, 0, 0.3);
            font-weight: bold;
        }
        
        .location-status.tracking {
            color: var(--tracking-orange);
            background-color: rgba(255, 87, 34, 0.3);
            animation: pulse 2s infinite;
        }
        
        .location-status.gps {
            color: var(--gps-blue);
            background-color: rgba(0, 102, 255, 0.3);
        }
        
        .location-status.position {
            color: var(--my-position-color);
            background-color: rgba(255, 0, 255, 0.3);
            animation: pulse-position 2s infinite;
        }
        
        .mode-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mode-selector select {
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background-color: rgba(255, 255, 255, 0.9);
            color: #0a2f0a;
            font-weight: 600;
            min-width: 180px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .map-container {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }
        
        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }
        
        /* Mode plein écran */
        .map-container.fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            z-index: 9999 !important;
            background: white;
        }
        
        .map-container.fullscreen .map-controls {
            top: 20px;
            right: 20px;
        }
        
        .map-container.fullscreen .gps-dashboard {
            bottom: 30px;
            left: 30px;
        }
        
        .map-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 8px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            border: 2px solid var(--military-green);
        }
        
        .map-control {
            background-color: white;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            color: var(--military-green);
            transition: all 0.2s;
            border: 1px solid #ddd;
        }
        
        .map-control:hover {
            transform: translateY(-2px);
            border-color: var(--military-green);
            color: var(--military-green);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .map-control.active {
            background-color: var(--military-green);
            color: white;
            border-color: var(--military-green);
        }
        
        .map-control.gps {
            color: var(--gps-blue);
            border-color: var(--gps-blue);
        }
        
        .map-control.gps.active {
            background-color: var(--gps-blue);
            color: white;
            border-color: var(--gps-blue);
        }
        
        .map-control.tracking {
            color: var(--tracking-orange);
            border-color: var(--tracking-orange);
        }
        
        .map-control.tracking.active {
            background-color: var(--tracking-orange);
            color: white;
            border-color: var(--tracking-orange);
        }
        
        .map-control.whatsapp {
            color: var(--whatsapp-green);
            border-color: var(--whatsapp-green);
        }
        
        .map-control.whatsapp.active {
            background-color: var(--whatsapp-green);
            color: white;
            border-color: var(--whatsapp-green);
        }
        
        .map-control.position {
            color: var(--my-position-color);
            border-color: var(--my-position-color);
        }
        
        .map-control.position.active {
            background-color: var(--my-position-color);
            color: white;
            border-color: var(--my-position-color);
        }
        
        .map-control.satellite {
            color: var(--satellite-color);
            border-color: var(--satellite-color);
        }
        
        .map-control.satellite.active {
            background-color: var(--satellite-color);
            color: white;
            border-color: var(--satellite-color);
        }
        
        .map-control.topographic {
            color: var(--topographic-color);
            border-color: var(--topographic-color);
        }
        
        .map-control.topographic.active {
            background-color: var(--topographic-color);
            color: white;
            border-color: var(--topographic-color);
        }
        
        .map-control.military-map {
            color: var(--military-map-color);
            border-color: var(--military-map-color);
        }
        
        .map-control.military-map.active {
            background-color: var(--military-map-color);
            color: white;
            border-color: var(--military-map-color);
        }
        
        /* Dashboard GPS */
        .gps-dashboard {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            width: 320px;
            border: 3px solid var(--gps-blue);
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--gps-blue);
        }
        
        .dashboard-header h3 {
            font-size: 1rem;
            color: var(--gps-blue);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .gps-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .metric {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid var(--gps-blue);
        }
        
        .metric-label {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 4px;
        }
        
        .metric-value {
            font-size: 1rem;
            font-weight: bold;
            color: var(--gps-blue);
        }
        
        .metric-unit {
            font-size: 0.7rem;
            color: #666;
        }
        
        .tracking-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        /* Panneau de calcul de distance */
        .distance-panel {
            position: absolute;
            top: 15px;
            left: 380px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            width: 320px;
            border: 3px solid var(--route-color);
            display: none;
        }
        
        .distance-panel.active {
            display: block;
        }
        
        .distance-panel .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--route-color);
        }
        
        .distance-panel h3 {
            font-size: 1rem;
            color: var(--route-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .point-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .point-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .point-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .point-marker {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .point-a {
            background-color: #FF5722;
        }
        
        .point-b {
            background-color: #0066FF;
        }
        
        .distance-result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 3px solid var(--route-color);
        }
        
        .distance-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--route-color);
            text-align: center;
            margin: 10px 0;
        }
        
        /* Panneau de localisation */
        .location-panel {
            position: absolute;
            top: 15px;
            right: 380px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            width: 320px;
            border: 3px solid var(--my-position-color);
            display: none;
        }
        
        .location-panel.active {
            display: block;
        }
        
        .location-panel .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--my-position-color);
        }
        
        .location-panel h3 {
            font-size: 1rem;
            color: var(--my-position-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .location-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 3px solid var(--my-position-color);
        }
        
        .location-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        
        .location-info-item .label {
            color: #666;
            font-weight: 600;
        }
        
        .location-info-item .value {
            color: var(--my-position-color);
            font-weight: bold;
        }
        
        /* Panneau d'informations géographiques */
        .geography-panel {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            width: 350px;
            border: 3px solid var(--satellite-color);
            display: none;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .geography-panel.active {
            display: block;
        }
        
        .geography-panel .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--satellite-color);
        }
        
        .geography-panel h3 {
            font-size: 1rem;
            color: var(--satellite-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .geography-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 3px solid var(--satellite-color);
        }
        
        .geography-section {
            margin-bottom: 15px;
        }
        
        .geography-section h4 {
            color: var(--satellite-color);
            margin-bottom: 8px;
            font-size: 0.9rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        .geography-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.8rem;
        }
        
        .geography-info-item .label {
            color: #666;
            font-weight: 500;
        }
        
        .geography-info-item .value {
            color: #333;
            font-weight: 600;
            text-align: right;
        }
        
        /* Outils de dessin */
        .draw-tools {
            position: absolute;
            top: 80px;
            right: 70px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 6px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            flex-direction: column;
            gap: 8px;
            border: 2px solid var(--military-green);
        }
        
        .draw-tools.active {
            display: flex;
        }
        
        .draw-tool {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--military-green);
            background: white;
            border: 1px solid #ddd;
            transition: all 0.2s;
        }
        
        .draw-tool:hover {
            background-color: var(--military-green);
            color: white;
            transform: translateY(-2px);
        }
        
        /* Barre d'état militaire */
        .status-bar {
            background: linear-gradient(90deg, #0a2f0a 0%, var(--primary-color) 100%);
            padding: 8px 15px;
            font-size: 0.75rem;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            border-top: 2px solid var(--accent-color);
            min-height: 36px;
        }
        
        #status-message {
            flex-grow: 1;
            font-weight: 500;
        }
        
        .coordinate-system {
            font-family: 'Courier New', monospace;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            color: var(--accent-color);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 12px 15px;
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.3s;
            border-left: 4px solid var(--primary-color);
            max-width: 350px;
        }
        
        .notification.active {
            transform: translateX(0);
        }
        
        .notification.military {
            border-left-color: var(--military-green);
        }
        
        .notification.gps {
            border-left-color: var(--gps-blue);
        }
        
        .notification.tracking {
            border-left-color: var(--tracking-orange);
        }
        
        .notification.whatsapp {
            border-left-color: var(--whatsapp-green);
        }
        
        .notification.route {
            border-left-color: var(--route-color);
        }
        
        .notification.position {
            border-left-color: var(--my-position-color);
        }
        
        .notification.export {
            border-left-color: var(--export-color);
        }
        
        .notification.import {
            border-left-color: var(--import-color);
        }
        
        .notification.satellite {
            border-left-color: var(--satellite-color);
        }
        
        .notification.topographic {
            border-left-color: var(--topographic-color);
        }
        
        .notification.military-map {
            border-left-color: var(--military-map-color);
        }
        
        /* Modal d'importation */
        .import-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 4000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .import-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .import-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            padding: 25px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            border: 3px solid var(--import-color);
            transform: translateY(-20px);
            transition: transform 0.3s;
        }
        
        .import-modal.active .import-content {
            transform: translateY(0);
        }
        
        .import-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--import-color);
        }
        
        .import-header h3 {
            color: var(--import-color);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-import {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .close-import:hover {
            color: var(--import-color);
        }
        
        .file-upload-area {
            border: 3px dashed #ddd;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .file-upload-area:hover {
            border-color: var(--import-color);
            background: rgba(33, 150, 243, 0.05);
        }
        
        .file-upload-area.dragover {
            border-color: var(--import-color);
            background: rgba(33, 150, 243, 0.1);
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 3rem;
            color: var(--import-color);
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-info {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }
        
        .file-info.active {
            display: block;
        }
        
        .file-name {
            font-weight: bold;
            color: var(--import-color);
            margin-bottom: 5px;
        }
        
        .file-size {
            font-size: 0.9rem;
            color: #666;
        }
        
        .import-options {
            margin-top: 20px;
        }
        
        .option-group {
            margin-bottom: 15px;
        }
        
        .option-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .option-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Boutons de contrôle de couche */
        .layer-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .layer-btn {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--satellite-color);
            color: var(--satellite-color);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .layer-btn:hover {
            background: var(--satellite-color);
            color: white;
            transform: translateY(-2px);
        }
        
        .layer-btn.active {
            background: var(--satellite-color);
            color: white;
        }
        
        .layer-btn.topographic {
            border-color: var(--topographic-color);
            color: var(--topographic-color);
        }
        
        .layer-btn.topographic:hover,
        .layer-btn.topographic.active {
            background: var(--topographic-color);
            color: white;
        }
        
        .layer-btn.military-map {
            border-color: var(--military-map-color);
            color: var(--military-map-color);
        }
        
        .layer-btn.military-map:hover,
        .layer-btn.military-map.active {
            background: var(--military-map-color);
            color: white;
        }
        
        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes pulse-gps {
            0% { box-shadow: 0 0 0 0 rgba(0, 102, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 102, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 102, 255, 0); }
        }
        
        @keyframes pulse-position {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 255, 0); }
        }
        
        @keyframes pulse-route {
            0% { box-shadow: 0 0 0 0 rgba(139, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(139, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(139, 0, 0, 0); }
        }
        
        /* Style pour le marqueur de position */
        .my-position-marker {
            animation: pulse-position 2s infinite;
        }
        
        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .main-sidebar {
                width: 240px;
            }
            .distance-panel {
                left: 280px;
                width: 280px;
            }
            .location-panel {
                right: 280px;
                width: 280px;
            }
            .geography-panel {
                width: 300px;
            }
        }
        
        @media (max-width: 992px) {
            .main-sidebar {
                width: 220px;
            }
            .distance-panel {
                left: 250px;
                width: 250px;
            }
            .location-panel {
                right: 250px;
                width: 250px;
            }
            .geography-panel {
                width: 280px;
            }
            .search-container {
                width: 250px;
            }
        }
        
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .main-sidebar {
                width: 100%;
                height: auto;
                max-height: 300px;
                flex-direction: row;
                flex-wrap: wrap;
                overflow-x: auto;
            }
            
            .logo {
                width: 100%;
                padding: 8px;
            }
            
            .tool-groups {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                padding: 8px;
            }
            
            .tool-group {
                margin-bottom: 0;
                min-width: 180px;
                flex-grow: 1;
            }
            
            .top-bar {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            
            .location-info {
                flex-direction: column;
                width: 100%;
                gap: 10px;
            }
            
            .search-container {
                width: 100%;
                order: 3;
            }
            
            .search-input:focus {
                width: 100%;
            }
            
            .mode-selector {
                width: 100%;
                justify-content: space-between;
            }
            
            .distance-panel {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 400px;
                z-index: 2000;
            }
            
            .location-panel {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 400px;
                z-index: 2000;
            }
            
            .geography-panel {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 400px;
                z-index: 2000;
            }
            
            .draw-tools {
                top: 70px;
                right: 15px;
            }
            
            .gps-dashboard {
                width: 90%;
                left: 5%;
                bottom: 10px;
            }
            
            .import-content {
                width: 95%;
                padding: 20px;
            }
            
            .layer-controls {
                top: 70px;
                left: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar militaire -->
    <div class="main-sidebar">
        <div class="logo">
            <div class="military-logo">
                <div class="world-icon">
                    <i class="fas fa-crosshairs"></i>
                </div>
                <h1>GeoHISTORY Pro MIL</h1>
                <div class="tagline">Système Cartographique Militaire</div>
                <div style="margin-top: 5px; font-size: 0.65rem; color: #FFD700;">
                    <i class="fas fa-shield-alt"></i> FORCES ARMÉES TOGOLAISES
                </div>
            </div>
        </div>
        
        <div class="tool-groups">
            <!-- Ma Position -->
            <div class="tool-group">
                <div class="tool-group-title">
                    <i class="fas fa-location-dot"></i>
                    <span>MA POSITION</span>
                </div>
                <div class="tool-buttons">
                    <button class="tool-btn position" id="find-my-position">
                        <i class="fas fa-location-crosshairs"></i>
                        Localiser Moi
                    </button>
                    <button class="tool-btn position" id="save-position">
                        <i class="fas fa-bookmark"></i>
                        Sauvegarder
                    </button>
                    <button class="tool-btn position" id="show-location-panel">
                        <i class="fas fa-info-circle"></i>
                        Détails Position
                    </button>
                </div>
            </div>
            
            <!-- Suivi GPS Automatique -->
            <div class="tool-group">
                <div class="tool-group-title">
                    <i class="fas fa-satellite"></i>
                    <span>SUIVI GPS AUTOMATIQUE</span>
                </div>
                <div class="tool-buttons">
                    <button class="tool-btn gps active" id="auto-gps">
                        <i class="fas fa-broadcast-tower"></i>
                        GPS Auto
                    </button>
                    <button class="tool-btn tracking" id="live-tracking">
                        <i class="fas fa-location-arrow"></i>
                        Suivi Live
                    </button>
                    <button class="tool-btn" id="fullscreen-map">
                        <i class="fas fa-expand"></i>
                        Plein écran
                    </button>
                </div>
            </div>
            
            <!-- Types de Carte -->
            <div class="tool-group">
                <div class="tool-group-title">
                    <i class="fas fa-layer-group"></i>
                    <span>TYPES DE CARTE</span>
                </div>
                <div class="tool-buttons">
                    <button class="tool-btn" id="map-type-standard">
                        <i class="fas fa-map"></i>
                        Standard
                    </button>
                    <button class="tool-btn satellite" id="map-type-satellite">
                        <i class="fas fa-satellite"></i>
                        Satellite
                    </button>
                    <button class="tool-btn topographic" id="map-type-topographic">
                        <i class="fas fa-mountain"></i>
                        Topographique
                    </button>
                    <button class="tool-btn military-map" id="map-type-military">
                        <i class="fas fa-chess-board"></i>
                        Carte Militaire
                    </button>
                    <button class="tool-btn" id="map-type-terrain">
                        <i class="fas fa-hill-rockslide"></i>
                        Relief
                    </button>
                    <button class="tool-btn" id="map-type-dark">
                        <i class="fas fa-moon"></i>
                        Mode Nuit
                    </button>
                </div>
            </div>
            
            <!-- Modification de Carte -->
            <div class="tool-group">
                <div class="tool-group-title">
                    <i class="fas fa-edit"></i>
                    <span>MODIFICATION DE CARTE</span>
                </div>
                <div class="tool-buttons">
                    <button class="tool-btn" id="draw-marker">
                        <i class="fas fa-map-marker-alt"></i>
                        Ajouter Marqueur
                    </button>
                    <button class="tool-btn" id="draw-polyline">
                        <i class="fas fa-draw-polygon"></i>
                        Dessiner Ligne
                    </button>
                    <button class="tool-btn" id="draw-polygon">
                        <i class="fas fa-draw-polygon"></i>
                        Dessiner Zone
                    </button>
                    <button class="tool-btn" id="clear-drawings">
                        <i class="fas fa-trash-alt"></i>
                        Effacer Dessins
                    </button>
                </div>
            </div>
            
            <!-- Calcul de Distance -->
            <div class="tool-group">
                <div class="tool-group-title">
                    <i class="fas fa-ruler-combined"></i>
                    <span>CALCUL DE DISTANCE</span>
                </div>
                <div class="tool-buttons">
                    <button class="tool-btn route" id="measure-distance">
                        <i class="fas fa-ruler"></i>
                        Mesurer Distance
                    </button>
                    <button class="tool-btn route" id="generate-route">
                        <i class="fas fa-route"></i>
                        Générer Trajet
                    </button>
                    <button class="tool-btn route" id="multi-point">
                        <i class="fas fa-map-pin"></i>
                        Points Multiples
                    </button>
                    <button class="tool-btn" id="export-measurements">
                        <i class="fas fa-file-export"></i>
                        Exporter Mesures
                    </button>
                </div>
            </div>
            
            <!-- Recherche Géographique -->
            <div class="tool-group">
                <div class="tool-group-title">
                    <i class="fas fa-search-location"></i>
                    <span>RECHERCHE GÉOGRAPHIQUE</span>
                </div>
                <div class="tool-buttons">
                    <button class="tool-btn satellite" id="search-location">
                        <i class="fas fa-search"></i>
                        Rechercher Lieu
                    </button>
                    <button class="tool-btn satellite" id="show-geography-panel">
                        <i class="fas fa-info-circle"></i>
                        Infos Géographiques
                    </button>
                    <button class="tool-btn topographic" id="get-elevation">
                        <i class="fas fa-mountain"></i>
                        Élévation
                    </button>
                </div>
            </div>
            
            <!-- Import/Export -->
            <div class="tool-group">
                <div class="tool-group-title">
                    <i class="fas fa-exchange-alt"></i>
                    <span>IMPORT/EXPORT</span>
                </div>
                <div class="tool-buttons">
                    <button class="tool-btn import" id="import-data">
                        <i class="fas fa-file-import"></i>
                        Importer JSON
                    </button>
                    <button class="tool-btn export" id="export-kml">
                        <i class="fas fa-file-export"></i>
                        Exporter KML
                    </button>
                    <button class="tool-btn" id="export-data">
                        <i class="fas fa-database"></i>
                        Exporter JSON
                    </button>
                </div>
            </div>
            
            <!-- Partage WhatsApp -->
            <div class="tool-group">
                <div class="tool-group-title">
                    <i class="fab fa-whatsapp"></i>
                    <span>PARTAGE WHATSAPP</span>
                </div>
                <div class="tool-buttons">
                    <button class="tool-btn whatsapp" id="whatsapp-share">
                        <i class="fas fa-share-alt"></i>
                        Partager position
                    </button>
                    <button class="tool-btn whatsapp" id="auto-whatsapp">
                        <i class="fas fa-robot"></i>
                        Auto-partage
                    </button>
                </div>
            </div>
            
            <!-- Système -->
            <div class="tool-group">
                <div class="tool-group-title">
                    <i class="fas fa-cogs"></i>
                    <span>SYSTÈME</span>
                </div>
                <div class="tool-buttons">
                    <button class="tool-btn" id="system-status">
                        <i class="fas fa-heartbeat"></i>
                        État système
                    </button>
                    <button class="tool-btn" id="reset-system">
                        <i class="fas fa-redo"></i>
                        Réinitialiser
                    </button>
                </div>
            </div>
        </div>
        
        <div style="padding: 10px; font-size: 0.7rem; opacity: 0.8; text-align: center; border-top: 1px solid rgba(255, 255, 255, 0.1); width: 100%;">
            <span class="coordinate-system">GPS LIVE - WGS84</span>
            <div style="margin-top: 5px; color: #FFD700;">
                <i class="fas fa-shield-alt"></i> SUIVI EN TEMPS RÉEL
            </div>
        </div>
    </div>
    
    <!-- Contenu principal -->
    <div class="main-content">
        <!-- Barre supérieure militaire -->
        <div class="top-bar">
            <div class="military-badge">
                <div class="fat-logo">
                    FAT
                </div>
                <div>
                    <h2 style="font-size: 1rem; font-weight: 700;">FORCES ARMÉES TOGOLAISES</h2>
                    <div style="font-size: 0.75rem; opacity: 0.9;">Système Cartographique Avancé</div>
                </div>
            </div>
            
            <div class="search-container">
                <input type="text" class="search-input" id="location-search" placeholder="Rechercher une localité, adresse, ville...">
                <button class="search-btn" id="search-btn">
                    <i class="fas fa-search"></i>
                </button>
                <div class="search-results" id="search-results"></div>
            </div>
            
            <div class="location-info">
                <div class="location-status gps" id="location-status">
                    <i class="fas fa-satellite"></i>
                    <span id="gps-status">GPS: INITIALISATION...</span>
                </div>
                
                <div class="mode-selector">
                    <select id="mode-select">
                        <option value="position">MA POSITION</option>
                        <option value="gps">MODE GPS</option>
                        <option value="tracking">SUIVI AUTOMATIQUE</option>
                        <option value="search">RECHERCHE</option>
                        <option value="measure">MESURE</option>
                        <option value="edit">ÉDITION</option>
                        <option value="satellite">SATELLITE</option>
                        <option value="topographic">TOPOGRAPHIQUE</option>
                        <option value="military">MILITAIRE</option>
                    </select>
                    <button class="action-btn tracking" id="tracking-toggle">
                        <i class="fas fa-play"></i> DÉMARRER
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Conteneur carte -->
        <div class="map-container" id="map-container">
            <div id="map"></div>
            
            <!-- Contrôles de couche -->
            <div class="layer-controls" id="layer-controls">
                <button class="layer-btn active" id="layer-standard">
                    <i class="fas fa-map"></i> Carte Standard
                </button>
                <button class="layer-btn" id="layer-satellite">
                    <i class="fas fa-satellite"></i> Satellite
                </button>
                <button class="layer-btn topographic" id="layer-topographic">
                    <i class="fas fa-mountain"></i> Topographique
                </button>
                <button class="layer-btn military-map" id="layer-military">
                    <i class="fas fa-chess-board"></i> Carte Militaire
                </button>
                <button class="layer-btn" id="layer-terrain">
                    <i class="fas fa-hill-rockslide"></i> Relief
                </button>
                <button class="layer-btn" id="layer-dark">
                    <i class="fas fa-moon"></i> Mode Nuit
                </button>
            </div>
            
            <!-- Dashboard GPS -->
            <div class="gps-dashboard" id="gps-dashboard">
                <div class="dashboard-header">
                    <h3><i class="fas fa-satellite-dish"></i> DASHBOARD GPS LIVE</h3>
                    <button id="close-dashboard" style="background: none; border: none; color: var(--gps-blue); cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="gps-metrics">
                    <div class="metric">
                        <div class="metric-label">POSITION</div>
                        <div class="metric-value" id="metric-position">--</div>
                        <div class="metric-unit">LAT, LNG</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">PRÉCISION</div>
                        <div class="metric-value" id="metric-accuracy">--</div>
                        <div class="metric-unit">mètres</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">VITESSE</div>
                        <div class="metric-value" id="metric-speed">--</div>
                        <div class="metric-unit">km/h</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">DISTANCE</div>
                        <div class="metric-value" id="metric-distance">0.00</div>
                        <div class="metric-unit">km</div>
                    </div>
                </div>
                
                <div class="tracking-controls">
                    <button class="action-btn gps" id="center-position" style="flex: 1;">
                        <i class="fas fa-crosshairs"></i> CENTRER
                    </button>
                    <button class="action-btn whatsapp" id="quick-share" style="flex: 1;">
                        <i class="fab fa-whatsapp"></i> PARTAGER
                    </button>
                    <button class="action-btn position" id="toggle-my-position" style="flex: 1;">
                        <i class="fas fa-location-dot"></i> MA POS
                    </button>
                </div>
            </div>
            
            <!-- Panneau de calcul de distance -->
            <div class="distance-panel" id="distance-panel">
                <div class="panel-header">
                    <h3><i class="fas fa-ruler-combined"></i> CALCUL DE DISTANCE</h3>
                    <button id="close-distance" style="background: none; border: none; color: var(--route-color); cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="point-info">
                    <div class="point-input">
                        <div class="point-marker point-a">A</div>
                        <input type="text" id="point-a-input" placeholder="Point A (cliquez sur la carte)" readonly>
                    </div>
                    <div class="point-input">
                        <div class="point-marker point-b">B</div>
                        <input type="text" id="point-b-input" placeholder="Point B (cliquez sur la carte)" readonly>
                    </div>
                </div>
                
                <div class="distance-result">
                    <div class="metric-label">DISTANCE ENTRE LES POINTS</div>
                    <div class="distance-value" id="distance-value">0.0 km</div>
                    <div id="distance-details" style="font-size: 0.8rem; text-align: center; color: #666;">
                        Distance en ligne droite
                    </div>
                </div>
                
                <div class="tracking-controls">
                    <button class="action-btn route" id="calculate-distance" style="flex: 1;">
                        <i class="fas fa-calculator"></i> CALCULER
                    </button>
                    <button class="action-btn route" id="generate-route-btn" style="flex: 1;">
                        <i class="fas fa-route"></i> TRAJET
                    </button>
                    <button class="action-btn" id="clear-points" style="flex: 1;">
                        <i class="fas fa-trash"></i> EFFACER
                    </button>
                </div>
            </div>
            
            <!-- Panneau de localisation -->
            <div class="location-panel" id="location-panel">
                <div class="panel-header">
                    <h3><i class="fas fa-location-dot"></i> MA POSITION ACTUELLE</h3>
                    <button id="close-location" style="background: none; border: none; color: var(--my-position-color); cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="location-details">
                    <div class="location-info-item">
                        <span class="label">Latitude:</span>
                        <span class="value" id="detail-lat">--</span>
                    </div>
                    <div class="location-info-item">
                        <span class="label">Longitude:</span>
                        <span class="value" id="detail-lng">--</span>
                    </div>
                    <div class="location-info-item">
                        <span class="label">Précision:</span>
                        <span class="value" id="detail-accuracy">--</span>
                    </div>
                    <div class="location-info-item">
                        <span class="label">Altitude:</span>
                        <span class="value" id="detail-altitude">--</span>
                    </div>
                    <div class="location-info-item">
                        <span class="label">Vitesse:</span>
                        <span class="value" id="detail-speed">--</span>
                    </div>
                    <div class="location-info-item">
                        <span class="label">Direction:</span>
                        <span class="value" id="detail-heading">--</span>
                    </div>
                    <div class="location-info-item">
                        <span class="label">Dernière mise à jour:</span>
                        <span class="value" id="detail-timestamp">--</span>
                    </div>
                </div>
                
                <div class="tracking-controls">
                    <button class="action-btn position" id="update-position" style="flex: 1;">
                        <i class="fas fa-sync-alt"></i> ACTUALISER
                    </button>
                    <button class="action-btn position" id="save-current-position" style="flex: 1;">
                        <i class="fas fa-bookmark"></i> SAUVEGARDER
                    </button>
                    <button class="action-btn whatsapp" id="share-my-position" style="flex: 1;">
                        <i class="fab fa-whatsapp"></i> PARTAGER
                    </button>
                </div>
            </div>
            
            <!-- Panneau d'informations géographiques -->
            <div class="geography-panel" id="geography-panel">
                <div class="panel-header">
                    <h3><i class="fas fa-globe-africa"></i> INFORMATIONS GÉOGRAPHIQUES</h3>
                    <button id="close-geography" style="background: none; border: none; color: var(--satellite-color); cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="geography-details">
                    <div class="geography-section">
                        <h4><i class="fas fa-map-marker-alt"></i> LOCALISATION</h4>
                        <div class="geography-info-item">
                            <span class="label">Lieu:</span>
                            <span class="value" id="geo-location">--</span>
                        </div>
                        <div class="geography-info-item">
                            <span class="label">Coordonnées:</span>
                            <span class="value" id="geo-coordinates">--</span>
                        </div>
                        <div class="geography-info-item">
                            <span class="label">Fuseau horaire:</span>
                            <span class="value" id="geo-timezone">--</span>
                        </div>
                        <div class="geography-info-item">
                            <span class="label">Pays:</span>
                            <span class="value" id="geo-country">--</span>
                        </div>
                    </div>
                    
                    <div class="geography-section">
                        <h4><i class="fas fa-mountain"></i> TOPOGRAPHIE</h4>
                        <div class="geography-info-item">
                            <span class="label">Altitude:</span>
                            <span class="value" id="geo-elevation">--</span>
                        </div>
                        <div class="geography-info-item">
                            <span class="label">Type de terrain:</span>
                            <span class="value" id="geo-terrain">--</span>
                        </div>
                        <div class="geography-info-item">
                            <span class="label">Pente estimée:</span>
                            <span class="value" id="geo-slope">--</span>
                        </div>
                    </div>
                    
                    <div class="geography-section">
                        <h4><i class="fas fa-tint"></i> HYDROGRAPHIE</h4>
                        <div class="geography-info-item">
                            <span class="label">Proximité eau:</span>
                            <span class="value" id="geo-water">--</span>
                        </div>
                        <div class="geography-info-item">
                            <span class="label">Rivières à proximité:</span>
                            <span class="value" id="geo-rivers">--</span>
                        </div>
                    </div>
                    
                    <div class="geography-section">
                        <h4><i class="fas fa-road"></i> INFRASTRUCTURES</h4>
                        <div class="geography-info-item">
                            <span class="label">Routes principales:</span>
                            <span class="value" id="geo-roads">--</span>
                        </div>
                        <div class="geography-info-item">
                            <span class="label">Villes proches:</span>
                            <span class="value" id="geo-cities">--</span>
                        </div>
                        <div class="geography-info-item">
                            <span class="label">Aéroports:</span>
                            <span class="value" id="geo-airports">--</span>
                        </div>
                    </div>
                    
                    <div class="geography-section">
                        <h4><i class="fas fa-info-circle"></i> MÉTADONNÉES</h4>
                        <div class="geography-info-item">
                            <span class="label">Source:</span>
                            <span class="value" id="geo-source">OpenStreetMap</span>
                        </div>
                        <div class="geography-info-item">
                            <span class="label">Dernière mise à jour:</span>
                            <span class="value" id="geo-updated">--</span>
                        </div>
                    </div>
                </div>
                
                <div class="tracking-controls">
                    <button class="action-btn satellite" id="export-geography" style="flex: 1;">
                        <i class="fas fa-file-export"></i> EXPORTER
                    </button>
                    <button class="action-btn satellite" id="save-geography" style="flex: 1;">
                        <i class="fas fa-save"></i> SAUVEGARDER
                    </button>
                </div>
            </div>
            
            <!-- Outils de dessin -->
            <div class="draw-tools" id="draw-tools">
                <div class="draw-tool" id="draw-tool-marker" title="Ajouter un marqueur">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="draw-tool" id="draw-tool-polyline" title="Dessiner une ligne">
                    <i class="fas fa-slash"></i>
                </div>
                <div class="draw-tool" id="draw-tool-polygon" title="Dessiner une zone">
                    <i class="fas fa-draw-polygon"></i>
                </div>
                <div class="draw-tool" id="draw-tool-circle" title="Dessiner un cercle">
                    <i class="fas fa-circle"></i>
                </div>
                <div class="draw-tool" id="draw-tool-rectangle" title="Dessiner un rectangle">
                    <i class="fas fa-square"></i>
                </div>
            </div>
            
            <!-- Contrôles carte -->
            <div class="map-controls">
                <div class="map-control" id="zoom-in" title="Zoom +">
                    <i class="fas fa-plus"></i>
                </div>
                <div class="map-control" id="zoom-out" title="Zoom -">
                    <i class="fas fa-minus"></i>
                </div>
                <div class="map-control gps" id="locate-me" title="Ma position">
                    <i class="fas fa-crosshairs"></i>
                </div>
                <div class="map-control position" id="show-my-position" title="Afficher ma position">
                    <i class="fas fa-location-dot"></i>
                </div>
                <div class="map-control" id="toggle-measure" title="Mesurer">
                    <i class="fas fa-ruler"></i>
                </div>
                <div class="map-control" id="toggle-draw" title="Outils de dessin">
                    <i class="fas fa-pencil-alt"></i>
                </div>
                <div class="map-control satellite" id="toggle-geography" title="Informations géographiques">
                    <i class="fas fa-info-circle"></i>
                </div>
                <div class="map-control military-map" id="toggle-military-map" title="Carte militaire">
                    <i class="fas fa-chess-board"></i>
                </div>
                <div class="map-control" id="toggle-dashboard" title="Dashboard">
                    <i class="fas fa-chart-line"></i>
                </div>
            </div>
        </div>
        
        <!-- Barre d'état militaire -->
        <div class="status-bar">
            <div id="status-message">
                <i class="fas fa-shield-alt"></i> <span id="system-status-text">SYSTÈME GPS EN INITIALISATION...</span>
            </div>
            <div>
                <span id="coordinates">--, --</span> | 
                <span class="coordinate-system">GPS LIVE</span>
            </div>
        </div>
    </div>
    
    <!-- Modal d'importation -->
    <div class="import-modal" id="import-modal">
        <div class="import-content">
            <div class="import-header">
                <h3><i class="fas fa-file-import"></i> IMPORTATION DE DONNÉES</h3>
                <button class="close-import" id="close-import">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="file-upload-area" id="file-drop-area">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h4>Glissez-déposez votre fichier ici</h4>
                <p style="color: #666; margin: 10px 0;">Ou cliquez pour parcourir</p>
                <p style="font-size: 0.9rem; color: #888;">
                    Formats supportés: JSON (exporté depuis GeoHISTORY Pro)
                </p>
                <input type="file" id="file-input" class="file-input" accept=".json,.geojson">
            </div>
            
            <div class="file-info" id="file-info">
                <div class="file-name" id="file-name"></div>
                <div class="file-size" id="file-size"></div>
            </div>
            
            <div class="import-options">
                <div class="option-group">
                    <label>
                        <input type="checkbox" id="import-positions" checked>
                        <span>Importer les positions GPS</span>
                    </label>
                </div>
                
                <div class="option-group">
                    <label>
                        <input type="checkbox" id="import-markers" checked>
                        <span>Importer les marqueurs</span>
                    </label>
                </div>
                
                <div class="option-group">
                    <label>
                        <input type="checkbox" id="import-shapes" checked>
                        <span>Importer les formes dessinées</span>
                    </label>
                </div>
                
                <div class="option-group">
                    <label>
                        <input type="checkbox" id="import-settings" checked>
                        <span>Importer les paramètres</span>
                    </label>
                </div>
            </div>
            
            <div class="tracking-controls" style="margin-top: 25px;">
                <button class="action-btn import" id="confirm-import" style="flex: 2;" disabled>
                    <i class="fas fa-file-import"></i> IMPORTER LES DONNÉES
                </button>
                <button class="action-btn" id="cancel-import" style="flex: 1;">
                    <i class="fas fa-times"></i> ANNULER
                </button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-info-circle"></i>
        <span id="notification-message">Système de suivi GPS initialisé</span>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        // =================== VARIABLES GLOBALES ===================
        let map;
        let currentPositionMarker = null;
        let accuracyCircle = null;
        let positionPath = null;
        let positionHistory = [];
        let positionWatchId = null;
        let lastPosition = null;
        let autoCenterEnabled = true;
        let autoTrackingEnabled = false;
        let autoWhatsAppEnabled = false;
        let drawControl = null;
        let drawnItems = new L.FeatureGroup();
        let distancePoints = { pointA: null, pointB: null };
        let distanceMarkers = [];
        let distanceLine = null;
        let isMeasuring = false;
        let isDrawing = false;
        let totalDistance = 0;
        let multiPointsMode = false;
        let multiPoints = [];
        let multiPointsLine = null;
        let currentDrawMode = null;
        let myPositionMarker = null;
        let myPositionAccuracyCircle = null;
        let savedPositions = [];
        let isShowingMyPosition = false;
        let isFullscreen = false;
        let importedFile = null;
        let currentLayer = 'standard';
        let layers = {};
        let searchMarker = null;
        let geographyData = null;
        let searchTimeout = null;
        
        // Configuration GPS OPTIMISÉE
        const GPS_CONFIG = {
            highAccuracy: true,
            maximumAge: 5000,
            timeout: 10000,
            enableHighAccuracy: true,
            maxHistory: 1000,
            autoCenterZoom: 16,
            positionUpdateInterval: 1000,
            minDistance: 3,
            whatsappPhone: "+22892871605",
            fallbackMode: false,
            useIPLocation: true,
            cachePosition: true,
            retryAttempts: 5,
            satelliteCount: 0,
            gpsSignalQuality: "unknown",
            maxAccuracyThreshold: 100,
            minAccuracyThreshold: 5,
            accuracyFilter: true,
            driftCorrection: true,
            smoothing: true
        };
        
        // Variables de contrôle GPS
        let gpsRetryCount = 0;
        let gpsLastSuccess = null;
        let gpsErrorCount = 0;
        let gpsSignalStrength = 0;
        let isGpsAvailable = false;
        let isGpsInitialized = false;
        let fallbackPosition = null;
        let gpsWatchActive = false;
        let positionQueue = [];
        let lastValidAccuracy = null;
        
        // =================== INITIALISATION ===================
        
        function initMilitaryMap() {
            console.log("🚀 Initialisation de la carte militaire...");
            
            // Créer la carte avec vue sur le Togo
            map = L.map('map', {
                crs: L.CRS.EPSG3857,
                minZoom: 2,
                maxZoom: 20,
                zoomControl: false,
                preferCanvas: true,
                attributionControl: false,
                maxBounds: [[-90, -180], [90, 180]],
                maxBoundsViscosity: 1.0
            }).setView([8.6195, 0.8248], 8);
            
            // Initialiser les couches de carte - CORRECTION ICI
            initMapLayers();
            
            // Ajouter le groupe pour les éléments dessinés
            drawnItems.addTo(map);
            
            // Initialiser les contrôles de dessin
            initDrawControls();
            
            // Configurer les événements de la carte
            setupMapEvents();
            
            // Vérifier la disponibilité du GPS
            checkGPSAvailability().then(() => {
                // Démarrer le suivi GPS automatique avec gestion d'erreur
                startAutoGPS();
                
                // Charger la position en cache si disponible
                loadCachedPosition();
            }).catch(error => {
                console.error("Erreur d'initialisation GPS:", error);
                startFallbackMode();
            });
            
            // Mettre à jour l'interface
            updateStatusDisplay();
            
            showNotification("✅ Système cartographique militaire initialisé", "gps");
            
            // Démarrer la mise à jour en temps réel
            startInterfaceUpdates();
            
            // Charger les positions sauvegardées
            loadSavedPositions();
            
            console.log("✅ Carte initialisée avec succès");
        }
        
        function initMapLayers() {
            console.log("🗺️ Initialisation des couches de carte...");
            
            try {
                // Couche OpenStreetMap Standard
                layers.standard = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap',
                    detectRetina: true
                });
                
                // Couche Satellite (utilisant Esri World Imagery)
                layers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 19,
                    attribution: 'Tiles © Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                });
                
                // Couche Topographique détaillée
                layers.topographic = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    maxZoom: 17,
                    attribution: 'Map data: © OpenStreetMap contributors, SRTM | Map style: © OpenTopoMap (CC-BY-SA)'
                });
                
                // NOUVELLE COUCHE : Carte Militaire (Stamen Terrain avec contours)
                layers.military = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/terrain/{z}/{x}/{y}.jpg', {
                    maxZoom: 18,
                    attribution: 'Map tiles by Stamen Design, CC BY 3.0 — Map data © OpenStreetMap'
                });
                
                // Couche Relief (alternative topographique)
                layers.terrain = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/terrain-background/{z}/{x}/{y}.jpg', {
                    maxZoom: 18,
                    attribution: 'Map tiles by Stamen Design, CC BY 3.0 — Map data © OpenStreetMap'
                });
                
                // Couche Mode Nuit
                layers.dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap, © CartoDB'
                });
                
                // Vérifier que toutes les couches sont correctement créées
                Object.keys(layers).forEach(layerName => {
                    if (!layers[layerName]) {
                        console.error(`❌ Erreur: La couche ${layerName} n'a pas été créée correctement`);
                    }
                });
                
                // Ajouter la couche standard par défaut
                if (layers.standard) {
                    layers.standard.addTo(map);
                    currentLayer = 'standard';
                    console.log("✅ Couche standard ajoutée à la carte");
                } else {
                    console.error("❌ Impossible d'ajouter la couche standard");
                }
                
                console.log(`✅ ${Object.keys(layers).length} couches de carte initialisées`);
                
            } catch (error) {
                console.error("❌ Erreur lors de l'initialisation des couches:", error);
                // Fallback vers OpenStreetMap si erreur
                layers.standard = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);
                currentLayer = 'standard';
            }
        }
        
        function changeMapLayer(layerName) {
            console.log(`🔄 Changement de couche vers: ${layerName}`);
            
            if (!layers[layerName]) {
                console.error(`❌ Couche ${layerName} non disponible`);
                showNotification(`Couche ${layerName} non disponible`, "warning");
                return;
            }
            
            if (layers[currentLayer]) {
                try {
                    map.removeLayer(layers[currentLayer]);
                    console.log(`➖ Couche ${currentLayer} retirée`);
                } catch (error) {
                    console.warn(`⚠️ Impossible de retirer la couche ${currentLayer}:`, error);
                }
            }
            
            try {
                layers[layerName].addTo(map);
                currentLayer = layerName;
                
                console.log(`➕ Couche ${layerName} ajoutée`);
                
                // Mettre à jour les boutons
                document.querySelectorAll('.layer-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById('layer-' + layerName).classList.add('active');
                
                // Mettre à jour les boutons de la sidebar
                document.querySelectorAll('#map-type-standard, #map-type-satellite, #map-type-topographic, #map-type-military, #map-type-terrain, #map-type-dark').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById('map-type-' + layerName).classList.add('active');
                
                // Mettre à jour le contrôle map-control correspondant
                document.querySelectorAll('.map-control').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                let notificationMessage = "";
                switch(layerName) {
                    case 'standard':
                        notificationMessage = "Carte standard activée";
                        break;
                    case 'satellite':
                        notificationMessage = "Vue satellite activée";
                        break;
                    case 'topographic':
                        notificationMessage = "Carte topographique activée";
                        break;
                    case 'military':
                        notificationMessage = "Carte militaire activée - Conçue pour les opérations tactiques";
                        break;
                    case 'terrain':
                        notificationMessage = "Carte de relief activée";
                        break;
                    case 'dark':
                        notificationMessage = "Mode nuit activé";
                        break;
                }
                
                showNotification(`✅ ${notificationMessage}`, layerName === 'military' ? 'military-map' : layerName);
                
            } catch (error) {
                console.error(`❌ Erreur lors du changement vers la couche ${layerName}:`, error);
                showNotification(`Erreur lors du chargement de la carte ${layerName}`, "warning");
                
                // Fallback vers la couche standard
                if (layerName !== 'standard' && layers.standard) {
                    changeMapLayer('standard');
                }
            }
        }
        
        // =================== RECHERCHE DE LOCALITÉS ===================
        
        function setupSearch() {
            const searchInput = document.getElementById('location-search');
            const searchBtn = document.getElementById('search-btn');
            const searchResults = document.getElementById('search-results');
            
            // Recherche lors de la saisie
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 3) {
                    searchResults.classList.remove('active');
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    searchLocation(query);
                }, 500);
            });
            
            // Recherche au clic sur le bouton
            searchBtn.addEventListener('click', function() {
                const query = searchInput.value.trim();
                if (query.length >= 2) {
                    searchLocation(query);
                }
            });
            
            // Recherche avec Entrée
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const query = this.value.trim();
                    if (query.length >= 2) {
                        searchLocation(query);
                    }
                }
            });
            
            // Fermer les résultats en cliquant ailleurs
            document.addEventListener('click', function(e) {
                if (!searchResults.contains(e.target) && e.target !== searchInput && e.target !== searchBtn) {
                    searchResults.classList.remove('active');
                }
            });
        }
        
        function searchLocation(query) {
            console.log(`🔍 Recherche de: ${query}`);
            
            // Utiliser le service de géocodage de Nominatim (OpenStreetMap)
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&accept-language=fr`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    displaySearchResults(data);
                })
                .catch(error => {
                    console.error("Erreur de recherche:", error);
                    showNotification("Erreur lors de la recherche", "warning");
                });
        }
        
        function displaySearchResults(results) {
            const searchResults = document.getElementById('search-results');
            searchResults.innerHTML = '';
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">Aucun résultat trouvé</div>';
                searchResults.classList.add('active');
                return;
            }
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                
                let displayName = result.display_name;
                if (displayName.length > 100) {
                    displayName = displayName.substring(0, 100) + '...';
                }
                
                let typeIcon = '📍';
                if (result.type === 'city' || result.type === 'town') typeIcon = '🏙️';
                else if (result.type === 'village') typeIcon = '🏘️';
                else if (result.type === 'administrative') typeIcon = '🏛️';
                else if (result.class === 'water') typeIcon = '💧';
                else if (result.class === 'natural') typeIcon = '🌲';
                else if (result.class === 'mountain') typeIcon = '⛰️';
                
                item.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 3px;">${typeIcon} ${displayName}</div>
                    <div style="font-size: 0.75rem; color: #666;">
                        ${result.type ? result.type.charAt(0).toUpperCase() + result.type.slice(1) : 'Lieu'} | 
                        Lat: ${parseFloat(result.lat).toFixed(4)}°, Lon: ${parseFloat(result.lon).toFixed(4)}°
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    selectSearchResult(result);
                });
                
                searchResults.appendChild(item);
            });
            
            searchResults.classList.add('active');
        }
        
        function selectSearchResult(result) {
            const lat = parseFloat(result.lat);
            const lon = parseFloat(result.lon);
            
            // Centrer la carte sur le résultat
            map.setView([lat, lon], 14);
            
            // Ajouter un marqueur
            if (searchMarker) {
                map.removeLayer(searchMarker);
            }
            
            searchMarker = L.marker([lat, lon], {
                icon: L.divIcon({
                    className: 'search-marker',
                    html: '<i class="fas fa-search-location" style="color: #FF5722; font-size: 32px;"></i>',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32]
                })
            }).addTo(map);
            
            let popupContent = `<div style="min-width: 250px;">
                <h4 style="margin: 0 0 10px 0; color: #FF5722;">
                    <i class="fas fa-search-location"></i> RÉSULTAT DE RECHERCHE
                </h4>
                <div style="font-size: 0.9rem;">
                    <div><strong>Nom:</strong> ${result.display_name}</div>
                    <div><strong>Type:</strong> ${result.type || 'Non spécifié'}</div>
                    <div><strong>Classe:</strong> ${result.class || 'Non spécifié'}</div>
                    <div><strong>Latitude:</strong> ${lat.toFixed(6)}°</div>
                    <div><strong>Longitude:</strong> ${lon.toFixed(6)}°</div>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 8px;">
                    <button onclick="getGeographyInfo(${lat}, ${lon})" style="
                        flex: 1;
                        background: #2E7D32;
                        color: white;
                        border: none;
                        padding: 8px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 0.8rem;
                    ">
                        <i class="fas fa-info-circle"></i> Infos détaillées
                    </button>
                </div>
            </div>`;
            
            searchMarker.bindPopup(popupContent).openPopup();
            
            // Fermer les résultats de recherche
            document.getElementById('search-results').classList.remove('active');
            document.getElementById('location-search').value = result.display_name.split(',')[0];
            
            // Obtenir les informations géographiques détaillées
            getGeographyInfo(lat, lon);
            
            showNotification(`📍 ${result.display_name.split(',')[0]} trouvé`, "satellite");
        }
        
        // =================== INFORMATIONS GÉOGRAPHIQUES ===================
        
        async function getGeographyInfo(lat, lon) {
            console.log(`🌍 Récupération des informations géographiques pour ${lat}, ${lon}`);
            
            showNotification("Récupération des informations géographiques...", "satellite");
            
            try {
                // Récupérer les informations de géocodage inversé
                const reverseGeocodeUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&accept-language=fr`;
                
                const [reverseData, elevationData] = await Promise.all([
                    fetch(reverseGeocodeUrl).then(r => r.json()),
                    getElevationData(lat, lon)
                ]);
                
                geographyData = {
                    location: reverseData.display_name || "Non spécifié",
                    coordinates: `${lat.toFixed(6)}°, ${lon.toFixed(6)}°`,
                    address: reverseData.address || {},
                    elevation: elevationData,
                    timestamp: new Date().toISOString()
                };
                
                updateGeographyPanel(geographyData);
                showGeographyPanel();
                
                showNotification("Informations géographiques chargées", "satellite");
                
            } catch (error) {
                console.error("Erreur lors de la récupération des informations:", error);
                showNotification("Erreur lors du chargement des informations", "warning");
                
                // Afficher des informations minimales
                geographyData = {
                    location: "Position inconnue",
                    coordinates: `${lat.toFixed(6)}°, ${lon.toFixed(6)}°`,
                    address: {},
                    elevation: { elevation: 0, unit: "m" },
                    timestamp: new Date().toISOString()
                };
                
                updateGeographyPanel(geographyData);
                showGeographyPanel();
            }
        }
        
        async function getElevationData(lat, lon) {
            try {
                // Utiliser l'API Open-Elevation
                const url = `https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lon}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    return {
                        elevation: data.results[0].elevation,
                        unit: "m"
                    };
                }
            } catch (error) {
                console.warn("Erreur API élévation, utilisation de données estimées:", error);
            }
            
            // Données estimées en cas d'échec
            return {
                elevation: Math.round(Math.random() * 500),
                unit: "m (estimé)"
            };
        }
        
        function updateGeographyPanel(data) {
            // Mettre à jour les informations de localisation
            document.getElementById('geo-location').textContent = 
                data.location.length > 50 ? data.location.substring(0, 50) + '...' : data.location;
            document.getElementById('geo-coordinates').textContent = data.coordinates;
            
            // Informations d'adresse
            const address = data.address;
            document.getElementById('geo-country').textContent = address.country || "Non spécifié";
            document.getElementById('geo-timezone').textContent = "UTC+0"; // Simplifié
            
            // Topographie
            const elevation = data.elevation;
            document.getElementById('geo-elevation').textContent = 
                `${elevation.elevation.toFixed(0)} ${elevation.unit}`;
            
            // Type de terrain estimé
            let terrainType = "Plaine";
            if (elevation.elevation > 1000) terrainType = "Montagne";
            else if (elevation.elevation > 500) terrainType = "Colline";
            else if (elevation.elevation < 0) terrainType = "Sous le niveau de la mer";
            
            document.getElementById('geo-terrain').textContent = terrainType;
            
            // Pente estimée
            const slope = Math.min(Math.random() * 30, 45).toFixed(1);
            document.getElementById('geo-slope').textContent = `${slope}°`;
            
            // Hydrographie (simulée)
            const hasWater = Math.random() > 0.7;
            document.getElementById('geo-water').textContent = hasWater ? "À proximité" : "Éloignée";
            document.getElementById('geo-rivers').textContent = hasWater ? "1-2 cours d'eau" : "Aucun";
            
            // Infrastructures (simulées)
            document.getElementById('geo-roads').textContent = "Routes secondaires";
            document.getElementById('geo-cities').textContent = "Ville à 10-50km";
            document.getElementById('geo-airports').textContent = "Aéroport régional à 50-100km";
            
            // Métadonnées
            document.getElementById('geo-updated').textContent = new Date(data.timestamp).toLocaleString();
        }
        
        function showGeographyPanel() {
            const panel = document.getElementById('geography-panel');
            panel.classList.add('active');
            document.getElementById('toggle-geography').classList.add('active');
        }
        
        function hideGeographyPanel() {
            const panel = document.getElementById('geography-panel');
            panel.classList.remove('active');
            document.getElementById('toggle-geography').classList.remove('active');
        }
        
        function exportGeographyData() {
            if (!geographyData) {
                showNotification("Aucune donnée géographique à exporter", "warning");
                return;
            }
            
            const dataStr = JSON.stringify(geographyData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const filename = `geography_data_${new Date().toISOString().slice(0,10)}.json`;
            
            const link = document.createElement('a');
            link.href = dataUri;
            link.download = filename;
            link.click();
            
            showNotification("Données géographiques exportées", "satellite");
        }
        
        function saveGeographyData() {
            if (!geographyData) {
                showNotification("Aucune donnée géographique à sauvegarder", "warning");
                return;
            }
            
            try {
                localStorage.setItem('lastGeographyData', JSON.stringify(geographyData));
                showNotification("Données géographiques sauvegardées", "satellite");
            } catch (error) {
                console.error("Erreur lors de la sauvegarde:", error);
                showNotification("Erreur lors de la sauvegarde", "warning");
            }
        }
        
        // =================== FONCTIONS D'IMPORTATION ===================
        
        function showImportModal() {
            const modal = document.getElementById('import-modal');
            modal.classList.add('active');
            
            // Réinitialiser le formulaire
            document.getElementById('file-input').value = '';
            document.getElementById('file-info').classList.remove('active');
            document.getElementById('confirm-import').disabled = true;
            importedFile = null;
            
            showNotification("Prêt à importer des données", "import");
        }
        
        function setupFileUpload() {
            const fileInput = document.getElementById('file-input');
            const fileDropArea = document.getElementById('file-drop-area');
            const fileInfo = document.getElementById('file-info');
            const confirmBtn = document.getElementById('confirm-import');
            
            // Gestion du clic sur la zone de dépôt
            fileDropArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // Gestion du changement de fichier
            fileInput.addEventListener('change', (e) => {
                handleFileSelection(e.target.files[0]);
            });
            
            // Gestion du drag and drop
            fileDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileDropArea.classList.add('dragover');
            });
            
            fileDropArea.addEventListener('dragleave', () => {
                fileDropArea.classList.remove('dragover');
            });
            
            fileDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileDropArea.classList.remove('dragover');
                
                if (e.dataTransfer.files.length) {
                    handleFileSelection(e.dataTransfer.files[0]);
                }
            });
            
            function handleFileSelection(file) {
                if (!file) return;
                
                // Vérifier l'extension du fichier
                const validExtensions = ['.json', '.geojson'];
                const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
                
                if (!validExtensions.includes(fileExtension)) {
                    showNotification("Format de fichier non supporté. Utilisez .json ou .geojson", "warning");
                    return;
                }
                
                // Vérifier la taille du fichier (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showNotification("Fichier trop volumineux (max 10MB)", "warning");
                    return;
                }
                
                importedFile = file;
                
                // Afficher les informations du fichier
                document.getElementById('file-name').textContent = file.name;
                document.getElementById('file-size').textContent = formatFileSize(file.size);
                fileInfo.classList.add('active');
                confirmBtn.disabled = false;
                
                showNotification(`Fichier sélectionné: ${file.name}`, "import");
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function importDataFromFile() {
            if (!importedFile) {
                showNotification("Aucun fichier sélectionné", "warning");
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    processImportedData(data);
                } catch (error) {
                    console.error("Erreur lors du parsing du fichier:", error);
                    showNotification("Fichier JSON invalide", "warning");
                }
            };
            
            reader.onerror = function() {
                showNotification("Erreur lors de la lecture du fichier", "warning");
            };
            
            reader.readAsText(importedFile);
        }
        
        function processImportedData(data) {
            console.log("📂 Données importées:", data);
            
            // Vérifier la structure des données
            if (!data || typeof data !== 'object') {
                showNotification("Format de données invalide", "warning");
                return;
            }
            
            let importedCount = 0;
            
            // Importer les positions historiques
            if (document.getElementById('import-positions').checked && data.positionHistory) {
                if (Array.isArray(data.positionHistory)) {
                    data.positionHistory.forEach(pos => {
                        if (pos.lat && pos.lng) {
                            positionHistory.push({
                                lat: parseFloat(pos.lat),
                                lng: parseFloat(pos.lng),
                                timestamp: pos.timestamp ? new Date(pos.timestamp) : new Date()
                            });
                            importedCount++;
                        }
                    });
                    
                    // Mettre à jour le trajet
                    updatePositionPath();
                }
            }
            
            // Importer les positions sauvegardées
            if (document.getElementById('import-markers').checked && data.savedPositions) {
                if (Array.isArray(data.savedPositions)) {
                    data.savedPositions.forEach(savedPos => {
                        if (savedPos.lat && savedPos.lng) {
                            const position = {
                                lat: parseFloat(savedPos.lat),
                                lng: parseFloat(savedPos.lng),
                                timestamp: savedPos.timestamp ? new Date(savedPos.timestamp) : new Date(),
                                name: savedPos.name || `Position importée ${savedPositions.length + 1}`
                            };
                            
                            savedPositions.push(position);
                            
                            // Ajouter un marqueur sur la carte
                            const savedMarker = L.marker([position.lat, position.lng], {
                                icon: L.divIcon({
                                    className: 'saved-position-marker',
                                    html: '<i class="fas fa-bookmark" style="color: #FFD700; font-size: 28px;"></i>',
                                    iconSize: [28, 28],
                                    iconAnchor: [14, 28]
                                })
                            }).addTo(map);
                            
                            savedMarker.bindPopup(`
                                <div style="min-width: 200px;">
                                    <h4 style="margin: 0 0 10px 0; color: #FFD700;">
                                        <i class="fas fa-bookmark"></i> POSITION IMPORTÉE
                                    </h4>
                                    <div style="font-size: 0.9rem;">
                                        <div><strong>Nom:</strong> ${position.name}</div>
                                        <div><strong>Latitude:</strong> ${position.lat.toFixed(6)}°</div>
                                        <div><strong>Longitude:</strong> ${position.lng.toFixed(6)}°</div>
                                        <div><strong>Date:</strong> ${position.timestamp.toLocaleDateString()}</div>
                                        <div><strong>Heure:</strong> ${position.timestamp.toLocaleTimeString()}</div>
                                    </div>
                                </div>
                            `);
                            
                            drawnItems.addLayer(savedMarker);
                            importedCount++;
                        }
                    });
                    
                    savePositionsToStorage();
                }
            }
            
            // Importer les formes dessinées (simplifié)
            if (document.getElementById('import-shapes').checked && data.customMarkers) {
                // Pour des formes plus complexes, on pourrait utiliser GeoJSON
                console.log("Formes disponibles pour importation:", data.customMarkers);
            }
            
            // Importer les paramètres
            if (document.getElementById('import-settings').checked && data.gpsStats) {
                // Mettre à jour les statistiques GPS
                gpsErrorCount = data.gpsStats.errorCount || 0;
                gpsSignalStrength = data.gpsStats.signalStrength || 0;
                
                console.log("Paramètres GPS importés:", data.gpsStats);
            }
            
            // Mettre à jour la dernière position si disponible
            if (data.lastPosition && data.lastPosition.lat && data.lastPosition.lng) {
                lastPosition = {
                    lat: parseFloat(data.lastPosition.lat),
                    lng: parseFloat(data.lastPosition.lng),
                    accuracy: data.lastPosition.accuracy || 50,
                    speed: data.lastPosition.speed || 0,
                    altitude: data.lastPosition.altitude || 0,
                    heading: data.lastPosition.heading || 0,
                    timestamp: data.lastPosition.timestamp ? new Date(data.lastPosition.timestamp) : new Date(),
                    source: 'import'
                };
                
                updatePositionDisplay(lastPosition);
                updateMapPosition(lastPosition);
                importedCount++;
            }
            
            // Mettre à jour la distance totale
            if (data.totalDistance) {
                totalDistance = parseFloat(data.totalDistance) || 0;
                document.getElementById('metric-distance').textContent = totalDistance.toFixed(2);
            }
            
            // Fermer le modal
            closeImportModal();
            
            // Afficher le résultat
            showNotification(`✅ ${importedCount} éléments importés avec succès`, "import");
            
            // Recentrer la carte sur les données importées si nécessaire
            if (positionHistory.length > 0 || savedPositions.length > 0) {
                setTimeout(() => {
                    const bounds = getDataBounds();
                    if (bounds.isValid()) {
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                }, 500);
            }
        }
        
        function getDataBounds() {
            const bounds = L.latLngBounds();
            
            // Ajouter les positions historiques
            positionHistory.forEach(pos => {
                bounds.extend([pos.lat, pos.lng]);
            });
            
            // Ajouter les positions sauvegardées
            savedPositions.forEach(pos => {
                bounds.extend([pos.lat, pos.lng]);
            });
            
            // Ajouter la dernière position
            if (lastPosition) {
                bounds.extend([lastPosition.lat, lastPosition.lng]);
            }
            
            return bounds;
        }
        
        function closeImportModal() {
            const modal = document.getElementById('import-modal');
            modal.classList.remove('active');
        }
        
        // =================== FONCTIONS D'EXPORTATION KML ===================
        
        function exportToKML() {
            console.log("📤 Préparation de l'export KML...");
            
            // Collecter toutes les données à exporter
            const kmlData = generateKMLData();
            
            // Créer le fichier KML
            const kmlContent = createKMLContent(kmlData);
            
            // Télécharger le fichier
            downloadKMLFile(kmlContent);
        }
        
        function generateKMLData() {
            const data = {
                documentName: "GeoHISTORY Pro - Export",
                description: "Export des données cartographiques militaires",
                timestamp: new Date().toISOString(),
                positions: [],
                savedMarkers: [],
                track: [],
                shapes: []
            };
            
            // Positions sauvegardées
            savedPositions.forEach((pos, index) => {
                data.savedMarkers.push({
                    name: pos.name || `Position ${index + 1}`,
                    description: `Position sauvegardée le ${pos.timestamp.toLocaleString()}`,
                    coordinates: [pos.lng, pos.lat],
                    timestamp: pos.timestamp.toISOString()
                });
            });
            
            // Historique des positions (track)
            if (positionHistory.length > 0) {
                data.track = positionHistory.map(pos => ({
                    coordinates: [pos.lng, pos.lat],
                    timestamp: pos.timestamp.toISOString()
                }));
            }
            
            // Dernière position actuelle
            if (lastPosition) {
                data.positions.push({
                    name: "Position actuelle",
                    description: `Dernière position enregistrée - Précision: ${lastPosition.accuracy}m`,
                    coordinates: [lastPosition.lng, lastPosition.lat],
                    timestamp: lastPosition.timestamp.toISOString(),
                    accuracy: lastPosition.accuracy
                });
            }
            
            // Collecter les formes dessinées (simplifié)
            // Pour une implémentation complète, il faudrait parcourir drawnItems
            console.log("Formes disponibles pour export KML:", drawnItems.getLayers().length);
            
            return data;
        }
        
        function createKMLContent(data) {
            const timestamp = new Date().toISOString();
            
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>${data.documentName}</name>
    <description>${data.description}</description>
    <Style id="savedMarkerStyle">
      <IconStyle>
        <scale>1.2</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png</href>
        </Icon>
      </IconStyle>
    </Style>
    <Style id="currentPositionStyle">
      <IconStyle>
        <scale>1.5</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/pushpin/red-pushpin.png</href>
        </Icon>
      </IconStyle>
    </Style>
    <Style id="trackStyle">
      <LineStyle>
        <color>ff0066ff</color>
        <width>4</width>
      </LineStyle>
    </Style>
`;
            
            // Ajouter les marqueurs sauvegardés
            data.savedMarkers.forEach(marker => {
                kml += `    <Placemark>
      <name>${marker.name}</name>
      <description><![CDATA[${marker.description}]]></description>
      <styleUrl>#savedMarkerStyle</styleUrl>
      <Point>
        <coordinates>${marker.coordinates.join(',')},0</coordinates>
      </Point>
      <TimeStamp>
        <when>${marker.timestamp}</when>
      </TimeStamp>
    </Placemark>
`;
            });
            
            // Ajouter la position actuelle
            data.positions.forEach(pos => {
                kml += `    <Placemark>
      <name>${pos.name}</name>
      <description><![CDATA[${pos.description}]]></description>
      <styleUrl>#currentPositionStyle</styleUrl>
      <Point>
        <coordinates>${pos.coordinates.join(',')},0</coordinates>
      </Point>
      <TimeStamp>
        <when>${pos.timestamp}</when>
      </TimeStamp>
    </Placemark>
`;
            });
            
            // Ajouter le trajet (track)
            if (data.track.length > 0) {
                kml += `    <Placemark>
      <name>Trajet GPS</name>
      <description>Historique des positions GPS</description>
      <styleUrl>#trackStyle</styleUrl>
      <LineString>
        <extrude>1</extrude>
        <tessellate>1</tessellate>
        <altitudeMode>relativeToGround</altitudeMode>
        <coordinates>
`;
                
                data.track.forEach(point => {
                    kml += `          ${point.coordinates.join(',')},0\n`;
                });
                
                kml += `        </coordinates>
      </LineString>
    </Placemark>
`;
            }
            
            // Informations système
            kml += `    <Placemark>
      <name>Informations Système</name>
      <description><![CDATA[
        <h3>Informations d'export</h3>
        <p><strong>Système:</strong> GeoHISTORY Pro MIL</p>
        <p><strong>Date d'export:</strong> ${new Date().toLocaleString()}</p>
        <p><strong>Positions sauvegardées:</strong> ${data.savedMarkers.length}</p>
        <p><strong>Points de trajet:</strong> ${data.track.length}</p>
        <p><strong>Distance totale:</strong> ${totalDistance.toFixed(2)} km</p>
        <p><strong>Organisation:</strong> FORCES ARMÉES TOGOLAISES</p>
      ]]></description>
      <Point>
        <coordinates>${lastPosition ? lastPosition.lng : 0.8248},${lastPosition ? lastPosition.lat : 8.6195},0</coordinates>
      </Point>
    </Placemark>
`;
            
            kml += `  </Document>
</kml>`;
            
            return kml;
        }
        
        function downloadKMLFile(kmlContent) {
            const filename = `geohistory_export_${new Date().toISOString().slice(0,10)}.kml`;
            const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            
            URL.revokeObjectURL(url);
            
            showNotification(`✅ Fichier KML exporté: ${filename}`, "export");
            
            // Ajouter aux logs
            console.log(`📁 Fichier KML exporté: ${filename}`);
            console.log(`📊 Statistiques: ${savedPositions.length} marqueurs, ${positionHistory.length} points de trajet`);
        }
        
        // =================== FONCTIONS D'EXPORTATION JSON ===================
        
        function exportDataToJSON() {
            const data = {
                positionHistory: positionHistory,
                lastPosition: lastPosition,
                totalDistance: totalDistance,
                savedPositions: savedPositions,
                timestamp: new Date().toISOString(),
                gpsStats: {
                    errorCount: gpsErrorCount,
                    signalStrength: gpsSignalStrength,
                    fallbackMode: GPS_CONFIG.fallbackMode,
                    retryCount: gpsRetryCount,
                    watchActive: gpsWatchActive
                },
                metadata: {
                    version: "1.0",
                    system: "GeoHISTORY Pro MIL",
                    organization: "FORCES ARMÉES TOGOLAISES"
                }
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `geohistory_data_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification("✅ Données JSON exportées avec succès", "export");
        }
        
        function exportMeasurements() {
            const measurements = {
                distancePoints: distancePoints,
                multiPoints: multiPoints,
                timestamp: new Date().toISOString(),
                metadata: {
                    type: "measurements",
                    system: "GeoHISTORY Pro MIL"
                }
            };
            
            const dataStr = JSON.stringify(measurements, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `measurements_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification("✅ Mesures exportées avec succès", "export");
        }
        
        // =================== FONCTIONS GPS ===================
        
        async function checkGPSAvailability() {
            console.log("📡 Vérification de la disponibilité du GPS...");
            
            if (!navigator.geolocation) {
                console.warn("❌ Geolocation API non supportée par le navigateur");
                showNotification("⚠️ Votre navigateur ne supporte pas la géolocalisation", "warning");
                isGpsAvailable = false;
                return Promise.reject("Geolocation API not supported");
            }
            
            return new Promise((resolve, reject) => {
                const testOptions = {
                    enableHighAccuracy: false,
                    timeout: 5000,
                    maximumAge: Infinity
                };
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log("✅ GPS fonctionnel, position obtenue:", position.coords);
                        isGpsAvailable = true;
                        isGpsInitialized = true;
                        document.getElementById('gps-status').textContent = "GPS: PRÊT";
                        resolve(position);
                    },
                    (error) => {
                        console.warn("⚠️ GPS test échoué:", error.message);
                        isGpsAvailable = false;
                        
                        if (navigator.permissions && navigator.permissions.query) {
                            navigator.permissions.query({ name: 'geolocation' })
                                .then((permissionStatus) => {
                                    console.log("📋 Statut permission:", permissionStatus.state);
                                    
                                    if (permissionStatus.state === 'granted') {
                                        isGpsAvailable = true;
                                        document.getElementById('gps-status').textContent = "GPS: ATTENTE SIGNAL";
                                        showNotification("GPS prêt, en attente de signal...", "gps");
                                        resolve(null);
                                    } else if (permissionStatus.state === 'prompt') {
                                        document.getElementById('gps-status').textContent = "GPS: DEMANDE PERMISSION";
                                        showNotification("Veuillez autoriser l'accès à votre position", "gps");
                                    } else {
                                        document.getElementById('gps-status').textContent = "GPS: PERMISSION REFUSÉE";
                                        showNotification("Permission GPS refusée. Activez-la dans les paramètres.", "warning");
                                    }
                                    
                                    permissionStatus.onchange = function() {
                                        console.log("🔄 Statut permission changé:", this.state);
                                        checkGPSAvailability();
                                    };
                                    
                                    reject(error);
                                })
                                .catch(() => {
                                    isGpsAvailable = true;
                                    document.getElementById('gps-status').textContent = "GPS: PRÊT";
                                    resolve(null);
                                });
                        } else {
                            isGpsAvailable = true;
                            document.getElementById('gps-status').textContent = "GPS: PRÊT";
                            resolve(null);
                        }
                    },
                    testOptions
                );
            });
        }
        
        function startAutoGPS() {
            console.log("📍 Démarrage du suivi GPS...");
            
            stopGPSWatch();
            
            if (!isGpsAvailable) {
                console.warn("⚠️ GPS non disponible, activation du mode dégradé");
                startFallbackMode();
                return;
            }
            
            const gpsOptions = {
                enableHighAccuracy: GPS_CONFIG.highAccuracy,
                timeout: GPS_CONFIG.timeout,
                maximumAge: GPS_CONFIG.maximumAge
            };
            
            console.log("🔧 Configuration GPS:", gpsOptions);
            
            try {
                positionWatchId = navigator.geolocation.watchPosition(
                    handlePositionSuccess,
                    handleGPSError,
                    gpsOptions
                );
                
                gpsWatchActive = true;
                gpsRetryCount = 0;
                
                console.log("✅ Suivi GPS démarré avec ID:", positionWatchId);
                
                document.getElementById('auto-gps').classList.add('active');
                document.getElementById('location-status').classList.add('active');
                
                showNotification("📡 Suivi GPS haute précision activé", "gps");
                
                setTimeout(() => {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            console.log("✅ Première position obtenue:", pos.coords);
                            handlePositionSuccess(pos);
                        },
                        (err) => {
                            console.warn("⚠️ Première position échouée:", err.message);
                        },
                        gpsOptions
                    );
                }, 1000);
                
            } catch (error) {
                console.error("❌ Erreur lors du démarrage du GPS:", error);
                handleGPSError(error);
            }
        }
        
        function handlePositionSuccess(position) {
            gpsErrorCount = 0;
            gpsLastSuccess = new Date();
            
            const coords = position.coords;
            const timestamp = new Date(position.timestamp);
            
            console.log(`📍 Position reçue: ${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}`);
            console.log(`   Précision: ${coords.accuracy ? coords.accuracy.toFixed(0) : 'N/A'}m`);
            console.log(`   Vitesse: ${coords.speed ? (coords.speed * 3.6).toFixed(1) : '0'} km/h`);
            
            if (GPS_CONFIG.accuracyFilter && coords.accuracy) {
                if (coords.accuracy > GPS_CONFIG.maxAccuracyThreshold) {
                    console.warn(`⚠️ Position rejetée (précision trop faible: ${coords.accuracy}m)`);
                    showNotification(`Précision faible (${coords.accuracy}m)`, "warning");
                    return;
                }
                
                if (!lastValidAccuracy || coords.accuracy < lastValidAccuracy) {
                    lastValidAccuracy = coords.accuracy;
                }
            }
            
            calculateGPSSignalQuality(coords);
            
            let processedPosition = coords;
            if (GPS_CONFIG.smoothing) {
                processedPosition = smoothPosition(coords);
            }
            
            if (GPS_CONFIG.driftCorrection && lastPosition) {
                processedPosition = correctDrift(processedPosition, lastPosition);
            }
            
            const newPosition = {
                lat: processedPosition.latitude,
                lng: processedPosition.longitude,
                accuracy: processedPosition.accuracy || coords.accuracy,
                speed: processedPosition.speed || coords.speed || 0,
                altitude: processedPosition.altitude || coords.altitude || 0,
                heading: processedPosition.heading || coords.heading || 0,
                timestamp: timestamp,
                satelliteCount: GPS_CONFIG.satelliteCount,
                signalQuality: GPS_CONFIG.gpsSignalQuality,
                source: 'gps'
            };
            
            let shouldRecord = true;
            if (lastPosition) {
                const distance = calculateDistance(
                    lastPosition.lat, lastPosition.lng,
                    newPosition.lat, newPosition.lng
                );
                
                shouldRecord = distance >= GPS_CONFIG.minDistance || 
                              (coords.accuracy && lastPosition.accuracy && 
                               coords.accuracy < lastPosition.accuracy * 0.8);
            }
            
            if (shouldRecord) {
                lastPosition = newPosition;
                
                updatePositionDisplay(newPosition);
                updateMapPosition(newPosition);
                updatePositionHistory(newPosition);
                
                if (autoCenterEnabled && autoTrackingEnabled) {
                    map.setView([newPosition.lat, newPosition.lng], GPS_CONFIG.autoCenterZoom);
                }
                
                updateTotalDistance();
                
                if (GPS_CONFIG.cachePosition) {
                    cachePosition(newPosition);
                }
                
                if (autoWhatsAppEnabled) {
                    autoSharePosition();
                }
            }
        }
        
        function smoothPosition(coords) {
            positionQueue.push({
                latitude: coords.latitude,
                longitude: coords.longitude,
                accuracy: coords.accuracy,
                timestamp: Date.now()
            });
            
            if (positionQueue.length > 5) {
                positionQueue.shift();
            }
            
            if (positionQueue.length < 3) {
                return coords;
            }
            
            let totalWeight = 0;
            let latSum = 0;
            let lngSum = 0;
            let accuracySum = 0;
            
            for (let i = 0; i < positionQueue.length; i++) {
                const weight = (i + 1) / positionQueue.length;
                totalWeight += weight;
                
                latSum += positionQueue[i].latitude * weight;
                lngSum += positionQueue[i].longitude * weight;
                
                if (positionQueue[i].accuracy) {
                    accuracySum += positionQueue[i].accuracy * weight;
                }
            }
            
            return {
                latitude: latSum / totalWeight,
                longitude: lngSum / totalWeight,
                accuracy: accuracySum / totalWeight,
                speed: coords.speed,
                altitude: coords.altitude,
                heading: coords.heading
            };
        }
        
        function correctDrift(currentCoords, lastPosition) {
            const MAX_DRIFT_DISTANCE = 100;
            const MAX_DRIFT_SPEED = 200;
            
            if (!lastPosition) return currentCoords;
            
            const distance = calculateDistance(
                lastPosition.lat, lastPosition.lng,
                currentCoords.latitude, currentCoords.longitude
            ) * 1000;
            
            const timeDiff = (new Date() - lastPosition.timestamp) / 1000;
            const speed = (distance / timeDiff) * 3.6;
            
            if (speed > MAX_DRIFT_SPEED && distance > MAX_DRIFT_DISTANCE) {
                console.warn(`⚠️ Dérive GPS détectée: vitesse ${speed.toFixed(0)} km/h`);
                
                const correctionFactor = 0.3;
                
                return {
                    latitude: lastPosition.lat * (1 - correctionFactor) + currentCoords.latitude * correctionFactor,
                    longitude: lastPosition.lng * (1 - correctionFactor) + currentCoords.longitude * correctionFactor,
                    accuracy: Math.max(currentCoords.accuracy || 50, lastPosition.accuracy || 50),
                    speed: currentCoords.speed,
                    altitude: currentCoords.altitude,
                    heading: currentCoords.heading
                };
            }
            
            return currentCoords;
        }
        
        function handleGPSError(error) {
            gpsErrorCount++;
            const now = new Date();
            
            console.error(`❌ Erreur GPS #${gpsErrorCount}:`, error.message || error);
            
            let message = "";
            let errorCode = error.code || 0;
            
            switch(errorCode) {
                case 1:
                    message = "Permission GPS refusée. Veuillez autoriser l'accès à votre position dans les paramètres de votre navigateur.";
                    isGpsAvailable = false;
                    showNotification(message, "warning");
                    break;
                    
                case 2:
                    message = "Position non disponible. Vérifiez que le GPS est activé sur votre appareil et que vous êtes en extérieur.";
                    
                    if (gpsRetryCount < GPS_CONFIG.retryAttempts) {
                        gpsRetryCount++;
                        message += ` Tentative ${gpsRetryCount}/${GPS_CONFIG.retryAttempts}...`;
                        
                        setTimeout(() => {
                            console.log(`🔄 Tentative de reconnexion ${gpsRetryCount}...`);
                            startAutoGPS();
                        }, 2000 * gpsRetryCount);
                    } else {
                        message += " Activation du mode dégradé.";
                        startFallbackMode();
                    }
                    break;
                    
                case 3:
                    message = "Délai de localisation dépassé. Vérifiez votre connexion internet.";
                    
                    if (gpsRetryCount < GPS_CONFIG.retryAttempts) {
                        gpsRetryCount++;
                        message += ` Nouvelle tentative (${gpsRetryCount}/${GPS_CONFIG.retryAttempts})...`;
                        
                        setTimeout(() => {
                            console.log(`🔄 Nouvelle tentative avec timeout augmenté...`);
                            startAutoGPS();
                        }, 3000);
                    }
                    break;
                    
                default:
                    message = "Erreur inconnue du GPS. Code: " + errorCode;
            }
            
            updateGPSErrorDisplay(message, errorCode);
            
            if (gpsErrorCount <= 3) {
                showNotification(message, "warning");
            }
            
            if (gpsErrorCount >= 10) {
                console.warn("🚨 Trop d'erreurs GPS, activation du mode dégradé");
                startFallbackMode();
            }
        }
        
        function updateGPSErrorDisplay(message, errorCode) {
            const errorStatus = document.getElementById('gps-status');
            const systemStatus = document.getElementById('system-status-text');
            
            let statusText = "GPS: ERREUR";
            if (errorCode === 1) statusText = "GPS: PERMISSION REFUSÉE";
            else if (errorCode === 2) statusText = "GPS: POSITION INDISPONIBLE";
            else if (errorCode === 3) statusText = "GPS: TIMEOUT";
            
            errorStatus.textContent = statusText;
            systemStatus.textContent = message.substring(0, 100) + "...";
            
            document.getElementById('location-status').classList.remove('active', 'tracking', 'position');
            document.getElementById('location-status').classList.add('gps');
        }
        
        function stopGPSWatch() {
            if (positionWatchId && navigator.geolocation) {
                navigator.geolocation.clearWatch(positionWatchId);
                positionWatchId = null;
                gpsWatchActive = false;
                console.log("⏹️ Surveillance GPS arrêtée");
            }
        }
        
        function calculateGPSSignalQuality(coords) {
            if (!coords.accuracy) {
                GPS_CONFIG.gpsSignalQuality = "unknown";
                gpsSignalStrength = 0;
                return;
            }
            
            let quality = "excellent";
            let strength = 100;
            
            const accuracy = coords.accuracy;
            
            if (accuracy < 10) {
                quality = "excellent";
                strength = 100;
            } else if (accuracy < 20) {
                quality = "good";
                strength = 80;
            } else if (accuracy < 50) {
                quality = "medium";
                strength = 60;
            } else if (accuracy < 100) {
                quality = "poor";
                strength = 40;
            } else {
                quality = "very poor";
                strength = 20;
            }
            
            if (coords.speed && coords.speed > 2) {
                strength = Math.max(30, strength - 10);
            }
            
            GPS_CONFIG.gpsSignalQuality = quality;
            gpsSignalStrength = strength;
            
            updateSignalDisplay();
        }
        
        function updateSignalDisplay() {
            const signalElement = document.getElementById('gps-status');
            if (!signalElement) return;
            
            let signalText = "";
            let signalIcon = "📡";
            
            if (gpsSignalStrength >= 80) {
                signalText = "EXCELLENT";
                signalIcon = "📡";
            } else if (gpsSignalStrength >= 60) {
                signalText = "BON";
                signalIcon = "📡";
            } else if (gpsSignalStrength >= 40) {
                signalText = "MOYEN";
                signalIcon = "📡";
            } else if (gpsSignalStrength >= 20) {
                signalText = "FAIBLE";
                signalIcon = "📡";
            } else if (gpsSignalStrength > 0) {
                signalText = "TRÈS FAIBLE";
                signalIcon = "📡";
            } else {
                signalText = "PAS DE SIGNAL";
                signalIcon = "📵";
            }
            
            if (lastPosition && lastPosition.accuracy) {
                signalElement.innerHTML = `${signalIcon} ${signalText} (±${lastPosition.accuracy.toFixed(0)}m)`;
            } else {
                signalElement.innerHTML = `${signalIcon} ${signalText}`;
            }
        }
        
        function startFallbackMode() {
            console.log("🔄 Activation du mode dégradé...");
            
            GPS_CONFIG.fallbackMode = true;
            stopGPSWatch();
            
            showNotification("Mode dégradé activé - Utilisation des données disponibles", "warning");
            
            if (GPS_CONFIG.useIPLocation) {
                getIPLocation();
            }
            
            const cachedPos = getCachedPosition();
            if (cachedPos) {
                console.log("📍 Utilisation de la position en cache");
                updatePositionDisplay(cachedPos);
                updateMapPosition(cachedPos);
            } else {
                fallbackPosition = {
                    lat: 8.6195,
                    lng: 0.8248,
                    accuracy: 50000,
                    speed: 0,
                    altitude: 0,
                    heading: 0,
                    timestamp: new Date(),
                    source: 'fallback'
                };
                
                updatePositionDisplay(fallbackPosition);
                updateMapPosition(fallbackPosition);
            }
        }
        
        function getIPLocation() {
            console.log("🌐 Tentative de localisation par IP...");
            
            const ipServices = [
                'https://ipapi.co/json/',
                'https://ipinfo.io/json',
                'https://freegeoip.app/json/'
            ];
            
            const tryService = (index) => {
                if (index >= ipServices.length) {
                    console.warn("❌ Tous les services IP ont échoué");
                    return;
                }
                
                fetch(ipServices[index])
                    .then(response => {
                        if (!response.ok) throw new Error('Service non disponible');
                        return response.json();
                    })
                    .then(data => {
                        if (data.latitude && data.longitude) {
                            console.log("✅ Localisation IP obtenue:", data);
                            
                            const ipPosition = {
                                lat: parseFloat(data.latitude),
                                lng: parseFloat(data.longitude),
                                accuracy: 5000,
                                speed: 0,
                                altitude: 0,
                                heading: 0,
                                timestamp: new Date(),
                                source: 'ip',
                                city: data.city,
                                country: data.country_name
                            };
                            
                            fallbackPosition = ipPosition;
                            updatePositionDisplay(ipPosition);
                            updateMapPosition(ipPosition);
                            
                            showNotification(`📍 Position estimée: ${data.city || ''} ${data.country_name || ''}`, "gps");
                        } else {
                            throw new Error('Données incomplètes');
                        }
                    })
                    .catch(error => {
                        console.warn(`⚠️ Service IP ${index + 1} échoué:`, error.message);
                        setTimeout(() => tryService(index + 1), 1000);
                    });
            };
            
            tryService(0);
        }
        
        function cachePosition(position) {
            try {
                const cacheData = {
                    lat: position.lat,
                    lng: position.lng,
                    accuracy: position.accuracy,
                    timestamp: position.timestamp.toISOString(),
                    source: position.source || 'gps'
                };
                
                localStorage.setItem('lastCachedPosition', JSON.stringify(cacheData));
                localStorage.setItem('positionCacheTime', Date.now().toString());
                
                console.log("💾 Position mise en cache");
            } catch (e) {
                console.warn("⚠️ Impossible de sauvegarder la position en cache:", e);
            }
        }
        
        function getCachedPosition() {
            try {
                const cacheTime = localStorage.getItem('positionCacheTime');
                if (cacheTime) {
                    const age = Date.now() - parseInt(cacheTime);
                    if (age > 30 * 60 * 1000) {
                        console.log("🗑️ Cache trop vieux, ignoré");
                        return null;
                    }
                }
                
                const cached = localStorage.getItem('lastCachedPosition');
                if (cached) {
                    const data = JSON.parse(cached);
                    return {
                        lat: data.lat,
                        lng: data.lng,
                        accuracy: data.accuracy,
                        speed: 0,
                        altitude: 0,
                        heading: 0,
                        timestamp: new Date(data.timestamp),
                        source: data.source || 'cache'
                    };
                }
            } catch (e) {
                console.warn("⚠️ Impossible de lire la position en cache:", e);
            }
            return null;
        }
        
        function loadCachedPosition() {
            const cached = getCachedPosition();
            if (cached) {
                console.log("📂 Position en cache chargée");
                lastPosition = cached;
                updateMapPosition(cached);
            }
        }
        
        // =================== FONCTIONS DE LOCALISATION ===================
        
        function findMyPosition() {
            console.log("🔍 Recherche de la position...");
            
            if (!navigator.geolocation) {
                showNotification("Géolocalisation non supportée par votre navigateur", "warning");
                return;
            }
            
            showNotification("Recherche de votre position en cours...", "position");
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            };
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log("✅ Position trouvée:", position.coords);
                    updateMyPosition(position);
                    centerOnMyPosition();
                    showNotification("✅ Position trouvée avec succès !", "position");
                },
                function(error) {
                    console.error("❌ Erreur de géolocalisation:", error);
                    handlePositionError(error);
                },
                options
            );
        }
        
        function updateMyPosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const speed = position.coords.speed || 0;
            const altitude = position.coords.altitude || 0;
            const heading = position.coords.heading || 0;
            const timestamp = new Date(position.timestamp);
            
            console.log(`📍 Mise à jour position: ${lat}, ${lng}, précision: ${accuracy}m`);
            
            updateMyPositionMarker(lat, lng, accuracy, speed, heading);
            updateLocationDetails(position.coords, timestamp);
            
            document.getElementById('location-status').classList.add('position');
            document.getElementById('gps-status').textContent = `MA POSITION: ±${accuracy ? accuracy.toFixed(0) : '?'}m`;
            
            if (autoTrackingEnabled) {
                lastPosition = {
                    lat, lng, accuracy, speed, altitude, heading, timestamp
                };
                updatePositionDisplay(lastPosition);
            }
        }
        
        function updateMyPositionMarker(lat, lng, accuracy, speed, heading) {
            if (myPositionMarker) {
                map.removeLayer(myPositionMarker);
            }
            if (myPositionAccuracyCircle) {
                map.removeLayer(myPositionAccuracyCircle);
            }
            
            myPositionMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'my-position-marker',
                    html: createMyPositionMarkerHTML(speed, heading),
                    iconSize: [60, 60],
                    iconAnchor: [30, 30]
                }),
                zIndexOffset: 2000
            }).addTo(map);
            
            myPositionMarker.bindPopup(createMyPositionPopup(lat, lng, accuracy, speed, heading));
            
            if (accuracy) {
                myPositionAccuracyCircle = L.circle([lat, lng], {
                    radius: accuracy,
                    color: '#FF00FF',
                    fillColor: '#FF00FF',
                    fillOpacity: 0.1,
                    weight: 2,
                    dashArray: '5, 5'
                }).addTo(map);
            }
            
            isShowingMyPosition = true;
            document.getElementById('show-my-position').classList.add('active');
            document.getElementById('toggle-my-position').classList.add('active');
        }
        
        function createMyPositionMarkerHTML(speed, heading) {
            const speedText = speed > 0 ? `${(speed * 3.6).toFixed(0)} km/h` : 'Stationnaire';
            
            return `
                <div style="position: relative; width: 60px; height: 60px;">
                    <div style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: radial-gradient(circle, rgba(255,0,255,0.8) 0%, rgba(255,0,255,0.4) 70%, transparent 100%);
                        border-radius: 50%;
                        border: 4px solid white;
                        box-shadow: 0 0 20px rgba(255,0,255,0.7);
                        animation: pulse-position 2s infinite;
                    ">
                        <i class="fas fa-user" style="
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%) rotate(${heading}deg);
                            color: white;
                            font-size: 24px;
                        "></i>
                    </div>
                    <div style="
                        position: absolute;
                        bottom: -8px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: #FF00FF;
                        color: white;
                        padding: 3px 8px;
                        border-radius: 12px;
                        font-size: 11px;
                        font-weight: bold;
                        white-space: nowrap;
                        border: 2px solid white;
                    ">
                        VOUS
                    </div>
                </div>
            `;
        }
        
        function createMyPositionPopup(lat, lng, accuracy, speed, heading) {
            const time = new Date().toLocaleTimeString();
            const date = new Date().toLocaleDateString();
            const speedKmh = (speed * 3.6).toFixed(1);
            const accuracyText = accuracy ? accuracy.toFixed(0) : "Inconnue";
            const direction = getDirectionFromHeading(heading);
            
            return `
                <div style="min-width: 300px;">
                    <h4 style="margin: 0 0 10px 0; color: #FF00FF;">
                        <i class="fas fa-location-dot"></i> VOTRE POSITION
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85rem;">
                        <div>
                            <strong>Latitude:</strong><br>
                            ${lat.toFixed(6)}°
                        </div>
                        <div>
                            <strong>Longitude:</strong><br>
                            ${lng.toFixed(6)}°
                        </div>
                        <div>
                            <strong>Précision:</strong><br>
                            ±${accuracyText} m
                        </div>
                        <div>
                            <strong>Vitesse:</strong><br>
                            ${speedKmh} km/h
                        </div>
                        <div>
                            <strong>Direction:</strong><br>
                            ${direction}
                        </div>
                        <div>
                            <strong>Heure:</strong><br>
                            ${time}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 15px;">
                        <button onclick="centerOnMyPosition()" style="
                            flex: 1;
                            background: #FF00FF;
                            color: white;
                            border: none;
                            padding: 8px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 0.8rem;
                        ">
                            <i class="fas fa-crosshairs"></i> Centrer
                        </button>
                        <button onclick="saveCurrentPosition()" style="
                            flex: 1;
                            background: #006400;
                            color: white;
                            border: none;
                            padding: 8px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 0.8rem;
                        ">
                            <i class="fas fa-bookmark"></i> Sauvegarder
                        </button>
                    </div>
                </div>
            `;
        }
        
        function getDirectionFromHeading(heading) {
            if (heading === null || heading === undefined) return "Inconnue";
            const directions = ['Nord', 'Nord-Est', 'Est', 'Sud-Est', 'Sud', 'Sud-Ouest', 'Ouest', 'Nord-Ouest'];
            const index = Math.round(heading / 45) % 8;
            return directions[index];
        }
        
        function updateLocationDetails(coords, timestamp) {
            document.getElementById('detail-lat').textContent = coords.latitude.toFixed(6) + '°';
            document.getElementById('detail-lng').textContent = coords.longitude.toFixed(6) + '°';
            document.getElementById('detail-accuracy').textContent = coords.accuracy ? `±${coords.accuracy.toFixed(0)} m` : 'Inconnue';
            document.getElementById('detail-altitude').textContent = coords.altitude ? `${coords.altitude.toFixed(0)} m` : 'Inconnue';
            document.getElementById('detail-speed').textContent = coords.speed ? `${(coords.speed * 3.6).toFixed(1)} km/h` : '0.0 km/h';
            document.getElementById('detail-heading').textContent = coords.heading ? `${coords.heading.toFixed(0)}° (${getDirectionFromHeading(coords.heading)})` : 'Inconnue';
            document.getElementById('detail-timestamp').textContent = timestamp.toLocaleString();
        }
        
        function centerOnMyPosition() {
            if (myPositionMarker) {
                const latlng = myPositionMarker.getLatLng();
                map.setView([latlng.lat, latlng.lng], GPS_CONFIG.autoCenterZoom);
                showNotification("Centré sur votre position", "position");
            } else {
                showNotification("Position non disponible. Activez d'abord la localisation.", "warning");
            }
        }
        
        function toggleMyPositionDisplay() {
            if (myPositionMarker) {
                if (isShowingMyPosition) {
                    map.removeLayer(myPositionMarker);
                    if (myPositionAccuracyCircle) {
                        map.removeLayer(myPositionAccuracyCircle);
                    }
                    isShowingMyPosition = false;
                    document.getElementById('show-my-position').classList.remove('active');
                    document.getElementById('toggle-my-position').classList.remove('active');
                    showNotification("Votre position est masquée", "position");
                } else {
                    map.addLayer(myPositionMarker);
                    if (myPositionAccuracyCircle) {
                        map.addLayer(myPositionAccuracyCircle);
                    }
                    isShowingMyPosition = true;
                    document.getElementById('show-my-position').classList.add('active');
                    document.getElementById('toggle-my-position').classList.add('active');
                    showNotification("Votre position est affichée", "position");
                }
            } else {
                findMyPosition();
            }
        }
        
        function showLocationPanel() {
            const panel = document.getElementById('location-panel');
            panel.classList.add('active');
            
            if (myPositionMarker) {
                const latlng = myPositionMarker.getLatLng();
                if (lastPosition) {
                    updateLocationDetails(lastPosition, lastPosition.timestamp);
                }
            }
            
            showNotification("Panneau de position ouvert", "position");
        }
        
        function saveCurrentPosition() {
            if (!myPositionMarker) {
                showNotification("Aucune position à sauvegarder", "warning");
                return;
            }
            
            const latlng = myPositionMarker.getLatLng();
            const position = {
                lat: latlng.lat,
                lng: latlng.lng,
                timestamp: new Date(),
                name: `Position ${savedPositions.length + 1}`
            };
            
            savedPositions.push(position);
            savePositionsToStorage();
            
            const savedMarker = L.marker([latlng.lat, latlng.lng], {
                icon: L.divIcon({
                    className: 'saved-position-marker',
                    html: '<i class="fas fa-bookmark" style="color: #FFD700; font-size: 28px;"></i>',
                    iconSize: [28, 28],
                    iconAnchor: [14, 28]
                })
            }).addTo(map);
            
            savedMarker.bindPopup(`
                <div style="min-width: 200px;">
                    <h4 style="margin: 0 0 10px 0; color: #FFD700;">
                        <i class="fas fa-bookmark"></i> POSITION SAUVEGARDÉE
                    </h4>
                    <div style="font-size: 0.9rem;">
                        <div><strong>Nom:</strong> ${position.name}</div>
                        <div><strong>Latitude:</strong> ${position.lat.toFixed(6)}°</div>
                        <div><strong>Longitude:</strong> ${position.lng.toFixed(6)}°</div>
                        <div><strong>Date:</strong> ${position.timestamp.toLocaleDateString()}</div>
                        <div><strong>Heure:</strong> ${position.timestamp.toLocaleTimeString()}</div>
                    </div>
                </div>
            `);
            
            drawnItems.addLayer(savedMarker);
            
            showNotification("✅ Position sauvegardée avec succès", "position");
        }
        
        function savePositionsToStorage() {
            try {
                localStorage.setItem('savedPositions', JSON.stringify(savedPositions));
                console.log("💾 Positions sauvegardées dans le stockage local");
            } catch (e) {
                console.error("❌ Erreur lors de la sauvegarde des positions:", e);
            }
        }
        
        function loadSavedPositions() {
            try {
                const saved = localStorage.getItem('savedPositions');
                if (saved) {
                    savedPositions = JSON.parse(saved);
                    console.log(`📂 ${savedPositions.length} positions chargées du stockage local`);
                    showNotification(`${savedPositions.length} positions chargées`, "position");
                }
            } catch (e) {
                console.error("❌ Erreur lors du chargement des positions:", e);
            }
        }
        
        // =================== AUTRES FONCTIONS ===================
        
        function initDrawControls() {
            console.log("🎨 Initialisation des outils de dessin...");
            
            drawControl = new L.Control.Draw({
                position: 'topleft',
                draw: {
                    polygon: {
                        shapeOptions: {
                            color: '#006400',
                            weight: 3,
                            fillColor: '#228B22',
                            fillOpacity: 0.2
                        },
                        allowIntersection: false,
                        drawError: {
                            color: '#DC143C',
                            timeout: 1000
                        },
                        showArea: true,
                        metric: true
                    },
                    polyline: {
                        shapeOptions: {
                            color: '#0066FF',
                            weight: 4,
                            dashArray: '5, 5'
                        },
                        metric: true
                    },
                    circle: {
                        shapeOptions: {
                            color: '#FF5722',
                            weight: 3,
                            fillColor: '#FF5722',
                            fillOpacity: 0.1
                        },
                        metric: true
                    },
                    rectangle: {
                        shapeOptions: {
                            color: '#8B0000',
                            weight: 3,
                            fillColor: '#8B0000',
                            fillOpacity: 0.1
                        }
                    },
                    marker: {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: '<i class="fas fa-map-marker-alt" style="color: #DC143C; font-size: 24px;"></i>',
                            iconSize: [24, 24],
                            iconAnchor: [12, 24]
                        })
                    }
                },
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                }
            });
            
            console.log("✅ Outils de dessin initialisés");
        }
        
        function setupMapEvents() {
            console.log("🔧 Configuration des événements de la carte...");
            
            map.on('mousemove', function(e) {
                document.getElementById('coordinates').textContent = 
                    `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
            });
            
            map.on('click', function(e) {
                if (isMeasuring) {
                    if (multiPointsMode) {
                        addMultiPoint(e.latlng);
                    } else {
                        addDistancePoint(e.latlng);
                    }
                } else if (currentDrawMode === 'marker') {
                    addManualMarker(e.latlng);
                } else {
                    showPositionInfo(e.latlng);
                }
            });
            
            map.on(L.Draw.Event.CREATED, function(e) {
                const layer = e.layer;
                drawnItems.addLayer(layer);
                
                if (layer instanceof L.Polygon) {
                    const area = calculatePolygonArea(layer.getLatLngs()[0]);
                    layer.bindPopup(`Zone: ${(area / 1000000).toFixed(2)} km²`);
                    showNotification(`Zone créée: ${(area / 1000000).toFixed(2)} km²`, "gps");
                } else if (layer instanceof L.Polyline) {
                    const distance = calculatePolylineDistance(layer.getLatLngs());
                    layer.bindPopup(`Distance: ${distance.toFixed(2)} km`);
                    showNotification(`Ligne créée: ${distance.toFixed(2)} km`, "gps");
                } else if (layer instanceof L.Circle) {
                    const radius = layer.getRadius();
                    const area = Math.PI * radius * radius;
                    layer.bindPopup(`Rayon: ${radius.toFixed(0)} m | Surface: ${(area / 1000000).toFixed(2)} km²`);
                    showNotification(`Cercle créé: rayon ${radius.toFixed(0)} m`, "gps");
                } else if (layer instanceof L.Rectangle) {
                    const bounds = layer.getBounds();
                    const area = calculateRectangleArea(bounds);
                    layer.bindPopup(`Surface: ${(area / 1000000).toFixed(2)} km²`);
                    showNotification(`Rectangle créé: ${(area / 1000000).toFixed(2)} km²`, "gps");
                } else if (layer instanceof L.Marker) {
                    layer.bindPopup(`Marqueur ajouté`);
                    showNotification("Marqueur ajouté", "gps");
                }
                
                layer.openPopup();
            });
            
            map.on(L.Draw.Event.EDITED, function(e) {
                showNotification("Élément modifié", "gps");
            });
            
            map.on(L.Draw.Event.DELETED, function(e) {
                showNotification("Élément supprimé", "gps");
            });
            
            console.log("✅ Événements de carte configurés");
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function toRad(degrees) {
            return degrees * Math.PI / 180;
        }
        
        function calculatePolylineDistance(latlngs) {
            let totalDistance = 0;
            for (let i = 1; i < latlngs.length; i++) {
                totalDistance += calculateDistance(
                    latlngs[i-1].lat, latlngs[i-1].lng,
                    latlngs[i].lat, latlngs[i].lng
                );
            }
            return totalDistance;
        }
        
        function calculatePolygonArea(latlngs) {
            let area = 0;
            const len = latlngs.length;
            
            for (let i = 0; i < len; i++) {
                const j = (i + 1) % len;
                const xi = latlngs[i].lng * Math.PI / 180;
                const yi = latlngs[i].lat * Math.PI / 180;
                const xj = latlngs[j].lng * Math.PI / 180;
                const yj = latlngs[j].lat * Math.PI / 180;
                
                area += (xj - xi) * (2 + Math.sin(yi) + Math.sin(yj));
            }
            
            area = Math.abs(area * 6378137 * 6378137 / 2);
            return area;
        }
        
        function calculateRectangleArea(bounds) {
            const ne = bounds.getNorthEast();
            const sw = bounds.getSouthWest();
            
            const latDiff = ne.lat - sw.lat;
            const lngDiff = ne.lng - sw.lng;
            
            const latDist = latDiff * 111320;
            const lngDist = lngDiff * 111320 * Math.cos((ne.lat + sw.lat) * Math.PI / 360);
            
            return Math.abs(latDist * lngDist);
        }
        
        function addDistancePoint(latlng) {
            if (!distancePoints.pointA) {
                distancePoints.pointA = latlng;
                
                const marker = L.marker(latlng, {
                    icon: L.divIcon({
                        className: 'distance-marker',
                        html: '<div style="background-color: #FF5722; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white;">A</div>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(map);
                
                distanceMarkers.push(marker);
                
                document.getElementById('point-a-input').value = 
                    `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
                
                showNotification("Point A défini", "gps");
                
            } else if (!distancePoints.pointB) {
                distancePoints.pointB = latlng;
                
                const marker = L.marker(latlng, {
                    icon: L.divIcon({
                        className: 'distance-marker',
                        html: '<div style="background-color: #0066FF; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white;">B</div>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(map);
                
                distanceMarkers.push(marker);
                
                document.getElementById('point-b-input').value = 
                    `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
                
                calculateAndDisplayDistance();
                
                showNotification("Point B défini - Distance calculée", "gps");
                
            } else {
                clearDistancePoints();
                addDistancePoint(latlng);
            }
        }
        
        function calculateAndDisplayDistance() {
            if (!distancePoints.pointA || !distancePoints.pointB) {
                showNotification("Veuillez définir deux points", "warning");
                return;
            }
            
            const distance = calculateDistance(
                distancePoints.pointA.lat, distancePoints.pointA.lng,
                distancePoints.pointB.lat, distancePoints.pointB.lng
            );
            
            document.getElementById('distance-value').textContent = `${distance.toFixed(3)} km`;
            
            if (distanceLine) {
                map.removeLayer(distanceLine);
            }
            
            distanceLine = L.polyline([distancePoints.pointA, distancePoints.pointB], {
                color: '#8B0000',
                weight: 3,
                dashArray: '10, 5',
                opacity: 0.8
            }).addTo(map);
            
            const midPoint = [
                (distancePoints.pointA.lat + distancePoints.pointB.lat) / 2,
                (distancePoints.pointA.lng + distancePoints.pointB.lng) / 2
            ];
            
            const labelMarker = L.marker(midPoint, {
                icon: L.divIcon({
                    className: 'distance-label',
                    html: `<div style="background: white; padding: 5px 10px; border-radius: 4px; border: 2px solid #8B0000; font-weight: bold; color: #8B0000;">${distance.toFixed(2)} km</div>`,
                    iconSize: null,
                    iconAnchor: [0, 0]
                })
            }).addTo(map);
            
            distanceMarkers.push(labelMarker);
        }
        
        function generateRoute() {
            if (!distancePoints.pointA || !distancePoints.pointB) {
                showNotification("Veuillez définir deux points", "warning");
                return;
            }
            
            showNotification("Génération du trajet en cours...", "route");
            
            const url = `https://router.project-osrm.org/route/v1/driving/${distancePoints.pointA.lng},${distancePoints.pointA.lat};${distancePoints.pointB.lng},${distancePoints.pointB.lat}?overview=full&geometries=geojson`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const distance = (route.distance / 1000).toFixed(2);
                        const duration = Math.floor(route.duration / 60);
                        
                        if (distanceLine) {
                            map.removeLayer(distanceLine);
                        }
                        
                        const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        distanceLine = L.polyline(routeCoordinates, {
                            color: '#8B0000',
                            weight: 5,
                            opacity: 0.8,
                            lineCap: 'round',
                            lineJoin: 'round'
                        }).addTo(map);
                        
                        document.getElementById('distance-value').textContent = `${distance} km`;
                        document.getElementById('distance-details').innerHTML = `
                            <div>Distance routière: ${distance} km</div>
                            <div>Temps estimé: ${duration} min</div>
                        `;
                        
                        showNotification("Trajet généré avec succès", "route");
                    } else {
                        showNotification("Impossible de générer le trajet", "warning");
                    }
                })
                .catch(error => {
                    console.error("Erreur lors de la génération du trajet:", error);
                    showNotification("Erreur de génération de trajet", "warning");
                });
        }
        
        function clearDistancePoints() {
            distanceMarkers.forEach(marker => {
                if (marker && map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            });
            distanceMarkers = [];
            
            if (distanceLine && map.hasLayer(distanceLine)) {
                map.removeLayer(distanceLine);
                distanceLine = null;
            }
            
            distancePoints = { pointA: null, pointB: null };
            
            document.getElementById('point-a-input').value = '';
            document.getElementById('point-b-input').value = '';
            document.getElementById('distance-value').textContent = '0.0 km';
            document.getElementById('distance-details').textContent = 'Distance en ligne droite';
            
            showNotification("Points de mesure effacés", "gps");
        }
        
        function toggleMultiPointsMode() {
            multiPointsMode = !multiPointsMode;
            
            if (multiPointsMode) {
                document.getElementById('multi-point').classList.add('active');
                clearMultiPoints();
                showNotification("Mode points multiples activé - Cliquez pour ajouter des points", "route");
            } else {
                document.getElementById('multi-point').classList.remove('active');
                clearMultiPoints();
                showNotification("Mode points multiples désactivé", "route");
            }
        }
        
        function addMultiPoint(latlng) {
            multiPoints.push(latlng);
            
            const marker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'multi-point-marker',
                    html: `<div style="background-color: #FF5722; color: white; width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white;">${multiPoints.length}</div>`,
                    iconSize: [25, 25],
                    iconAnchor: [12.5, 12.5]
                })
            }).addTo(map);
            
            distanceMarkers.push(marker);
            
            updateMultiPointsLine();
            calculateMultiPointsDistance();
            
            showNotification(`Point ${multiPoints.length} ajouté`, "route");
        }
        
        function updateMultiPointsLine() {
            if (multiPoints.length > 1) {
                if (multiPointsLine) {
                    map.removeLayer(multiPointsLine);
                }
                
                multiPointsLine = L.polyline(multiPoints, {
                    color: '#8B0000',
                    weight: 3,
                    dashArray: '5, 5',
                    opacity: 0.7
                }).addTo(map);
            }
        }
        
        function calculateMultiPointsDistance() {
            if (multiPoints.length < 2) return;
            
            let totalDistance = 0;
            for (let i = 1; i < multiPoints.length; i++) {
                totalDistance += calculateDistance(
                    multiPoints[i-1].lat, multiPoints[i-1].lng,
                    multiPoints[i].lat, multiPoints[i].lng
                );
            }
            
            document.getElementById('distance-value').textContent = `${totalDistance.toFixed(3)} km`;
            document.getElementById('distance-details').textContent = `Distance totale: ${totalDistance.toFixed(2)} km (${multiPoints.length} points)`;
        }
        
        function clearMultiPoints() {
            multiPoints = [];
            
            if (multiPointsLine) {
                map.removeLayer(multiPointsLine);
                multiPointsLine = null;
            }
            
            distanceMarkers.forEach(marker => {
                if (marker && map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            });
            distanceMarkers = [];
            
            document.getElementById('distance-value').textContent = '0.0 km';
            document.getElementById('distance-details').textContent = 'Distance en ligne droite';
        }
        
        function toggleDrawTools() {
            isDrawing = !isDrawing;
            const drawTools = document.getElementById('draw-tools');
            
            if (isDrawing) {
                drawTools.classList.add('active');
                map.addControl(drawControl);
                document.getElementById('toggle-draw').classList.add('active');
                showNotification("Outils de dessin activés", "gps");
            } else {
                drawTools.classList.remove('active');
                map.removeControl(drawControl);
                document.getElementById('toggle-draw').classList.remove('active');
                showNotification("Outils de dessin désactivés", "gps");
            }
        }
        
        function setDrawMode(mode) {
            currentDrawMode = mode;
            showNotification(`Mode ${mode} activé - Cliquez sur la carte`, "gps");
        }
        
        function addManualMarker(latlng) {
            const marker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'manual-marker',
                    html: '<i class="fas fa-map-marker-alt" style="color: #DC143C; font-size: 32px;"></i>',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32]
                })
            }).addTo(map);
            
            marker.bindPopup(`
                <div style="min-width: 200px;">
                    <h4 style="margin: 0 0 10px 0; color: #DC143C;">
                        <i class="fas fa-map-marker-alt"></i> MARQUEUR
                    </h4>
                    <div style="font-size: 0.9rem;">
                        <div><strong>Latitude:</strong> ${latlng.lat.toFixed(6)}°</div>
                        <div><strong>Longitude:</strong> ${latlng.lng.toFixed(6)}°</div>
                    </div>
                </div>
            `).openPopup();
            
            drawnItems.addLayer(marker);
            showNotification("Marqueur ajouté", "gps");
        }
        
        function clearAllDrawings() {
            drawnItems.clearLayers();
            showNotification("Tous les dessins ont été effacés", "gps");
        }
        
        function sendWhatsAppPosition() {
            if (!lastPosition) {
                showNotification("Aucune position disponible", "warning");
                return;
            }
            
            const message = createWhatsAppMessage(lastPosition);
            const url = `https://wa.me/${GPS_CONFIG.whatsappPhone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
            
            showNotification("Position partagée sur WhatsApp", "whatsapp");
        }
        
        function createWhatsAppMessage(position) {
            const time = position.timestamp.toLocaleTimeString();
            const date = position.timestamp.toLocaleDateString();
            const speedKmh = (position.speed * 3.6).toFixed(1);
            const accuracy = position.accuracy ? position.accuracy.toFixed(0) : "Inconnue";
            
            return `📍 *POSITION GPS LIVE - FORCES ARMÉES TOGOLAISES* 📍

📅 Date: ${date}
⏰ Heure: ${time}

📍 *Coordonnées GPS:*
Latitude: ${position.lat.toFixed(6)}
Longitude: ${position.lng.toFixed(6)}
Précision: ±${accuracy}m
Vitesse: ${speedKmh} km/h

🗺️ *Liens de localisation:*
Google Maps: https://maps.google.com/?q=${position.lat},${position.lng}
OpenStreetMap: https://www.openstreetmap.org/#map=16/${position.lat}/${position.lng}

📍 *Navigation rapide:*
https://www.google.com/maps/dir/?api=1&destination=${position.lat},${position.lng}

⚠️ *Système militaire FAT - Suivi en temps réel*
Généré automatiquement par GeoHISTORY Pro MIL`;
        }
        
        function toggleAutoWhatsApp() {
            autoWhatsAppEnabled = !autoWhatsAppEnabled;
            
            if (autoWhatsAppEnabled) {
                document.getElementById('auto-whatsapp').classList.add('active');
                showNotification("Auto-partage WhatsApp activé", "whatsapp");
            } else {
                document.getElementById('auto-whatsapp').classList.remove('active');
                showNotification("Auto-partage WhatsApp désactivé", "whatsapp");
            }
        }
        
        function autoSharePosition() {
            const lastShare = localStorage.getItem('lastAutoShare');
            const now = new Date().getTime();
            
            if (!lastShare || (now - parseInt(lastShare)) > 300000) {
                sendWhatsAppPosition();
                localStorage.setItem('lastAutoShare', now.toString());
            }
        }
        
        function toggleMeasureMode() {
            isMeasuring = !isMeasuring;
            const distancePanel = document.getElementById('distance-panel');
            
            if (isMeasuring) {
                distancePanel.classList.add('active');
                document.getElementById('toggle-measure').classList.add('active');
                showNotification("Mode mesure activé - Cliquez sur la carte pour définir les points", "gps");
            } else {
                distancePanel.classList.remove('active');
                document.getElementById('toggle-measure').classList.remove('active');
                clearDistancePoints();
                clearMultiPoints();
                showNotification("Mode mesure désactivé", "gps");
            }
        }
        
        function toggleAutoTracking() {
            autoTrackingEnabled = !autoTrackingEnabled;
            
            if (autoTrackingEnabled) {
                document.getElementById('tracking-toggle').innerHTML = '<i class="fas fa-stop"></i> ARRÊTER';
                document.getElementById('tracking-toggle').classList.add('tracking');
                document.getElementById('location-status').classList.add('tracking');
                document.getElementById('live-tracking').classList.add('active');
                showNotification("Suivi automatique activé", "tracking");
            } else {
                document.getElementById('tracking-toggle').innerHTML = '<i class="fas fa-play"></i> DÉMARRER';
                document.getElementById('tracking-toggle').classList.remove('tracking');
                document.getElementById('location-status').classList.remove('tracking');
                document.getElementById('live-tracking').classList.remove('active');
                showNotification("Suivi automatique désactivé", "tracking");
            }
        }
        
        function toggleFullscreen() {
            const mapContainer = document.getElementById('map-container');
            
            if (!document.fullscreenElement) {
                mapContainer.classList.add('fullscreen');
                if (mapContainer.requestFullscreen) {
                    mapContainer.requestFullscreen();
                } else if (mapContainer.webkitRequestFullscreen) {
                    mapContainer.webkitRequestFullscreen();
                } else if (mapContainer.msRequestFullscreen) {
                    mapContainer.msRequestFullscreen();
                }
                isFullscreen = true;
                document.getElementById('fullscreen-map').classList.add('active');
                showNotification("Mode plein écran activé", "gps");
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                mapContainer.classList.remove('fullscreen');
                isFullscreen = false;
                document.getElementById('fullscreen-map').classList.remove('active');
                showNotification("Mode plein écran désactivé", "gps");
            }
        }
        
        function centerOnPosition() {
            if (lastPosition) {
                map.setView([lastPosition.lat, lastPosition.lng], GPS_CONFIG.autoCenterZoom);
                showNotification("Centré sur votre position", "gps");
            } else {
                showNotification("Aucune position disponible", "warning");
            }
        }
        
        function updatePositionDisplay(position) {
            document.getElementById('metric-position').textContent = 
                `${position.lat.toFixed(4)}, ${position.lng.toFixed(4)}`;
            document.getElementById('metric-accuracy').textContent = 
                position.accuracy ? position.accuracy.toFixed(0) : "--";
            document.getElementById('metric-speed').textContent = 
                position.speed ? (position.speed * 3.6).toFixed(1) : "0.0";
            document.getElementById('metric-distance').textContent = 
                totalDistance.toFixed(2);
            
            const accuracyText = position.accuracy ? `±${position.accuracy.toFixed(0)}m` : "Inconnue";
            const speedText = position.speed ? `${(position.speed * 3.6).toFixed(1)} km/h` : "Stationnaire";
            
            document.getElementById('gps-status').textContent = 
                `GPS: ${accuracyText} | ${speedText}`;
            
            document.getElementById('system-status-text').textContent = 
                `GPS ${gpsWatchActive ? 'ACTIF' : 'INACTIF'} | ${accuracyText} | ${speedText} | Distance: ${totalDistance.toFixed(2)} km`;
            
            document.getElementById('coordinates').textContent = 
                `${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}`;
            
            updateSignalDisplay();
        }
        
        function updateMapPosition(position) {
            if (currentPositionMarker) {
                map.removeLayer(currentPositionMarker);
            }
            
            currentPositionMarker = L.marker([position.lat, position.lng], {
                icon: L.divIcon({
                    className: 'gps-marker',
                    html: createPositionMarkerHTML(position.speed, position.heading),
                    iconSize: [50, 50],
                    iconAnchor: [25, 25]
                })
            }).addTo(map);
            
            if (accuracyCircle) {
                map.removeLayer(accuracyCircle);
            }
            
            if (position.accuracy) {
                accuracyCircle = L.circle([position.lat, position.lng], {
                    radius: position.accuracy,
                    color: '#0066FF',
                    fillColor: '#0066FF',
                    fillOpacity: 0.1,
                    weight: 1,
                    dashArray: '5, 5'
                }).addTo(map);
            }
        }
        
        function createPositionMarkerHTML(speed, heading) {
            const speedClass = speed > 0 ? 'moving' : 'stationary';
            
            return `
                <div class="position-marker ${speedClass}" style="position: relative;">
                    <div style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 50px;
                        height: 50px;
                        background: radial-gradient(circle, rgba(0,102,255,0.8) 0%, rgba(0,102,255,0.4) 70%, transparent 100%);
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 0 15px rgba(0,102,255,0.5);
                        animation: pulse-gps 2s infinite;
                    ">
                        <i class="fas fa-user" style="
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%) rotate(${heading}deg);
                            color: white;
                            font-size: 20px;
                        "></i>
                    </div>
                    ${speed > 0 ? `
                    <div style="
                        position: absolute;
                        bottom: -5px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: #FF5722;
                        color: white;
                        padding: 2px 6px;
                        border-radius: 10px;
                        font-size: 10px;
                        font-weight: bold;
                        white-space: nowrap;
                    ">
                        ${(speed * 3.6).toFixed(0)} km/h
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        function updatePositionHistory(position) {
            positionHistory.push({
                lat: position.lat,
                lng: position.lng,
                timestamp: position.timestamp
            });
            
            if (positionHistory.length > GPS_CONFIG.maxHistory) {
                positionHistory.shift();
            }
            
            updatePositionPath();
        }
        
        function updatePositionPath() {
            const pathPoints = positionHistory.map(p => [p.lat, p.lng]);
            
            if (pathPoints.length > 1) {
                if (positionPath) {
                    map.removeLayer(positionPath);
                }
                
                positionPath = L.polyline(pathPoints, {
                    color: '#0066FF',
                    weight: 3,
                    opacity: 0.7,
                    lineCap: 'round',
                    lineJoin: 'round'
                }).addTo(map);
            }
        }
        
        function showPositionInfo(latlng) {
            const popup = L.popup()
                .setLatLng(latlng)
                .setContent(`
                    <div style="min-width: 250px;">
                        <h4 style="margin: 0 0 10px 0; color: #006400;">
                            <i class="fas fa-map-marker-alt"></i> COORDONNÉES
                        </h4>
                        <div style="font-size: 0.9rem; margin-bottom: 15px;">
                            <div><strong>Latitude:</strong> ${latlng.lat.toFixed(6)}°</div>
                            <div><strong>Longitude:</strong> ${latlng.lng.toFixed(6)}°</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="map.setView([${latlng.lat}, ${latlng.lng}], 16)" style="
                                flex: 1;
                                background: #006400;
                                color: white;
                                border: none;
                                padding: 8px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 0.8rem;
                            ">
                                <i class="fas fa-crosshairs"></i> Aller
                            </button>
                        </div>
                    </div>
                `)
                .openOn(map);
        }
        
        function showNotification(message, type = "gps") {
            const notification = document.getElementById('notification');
            const messageElement = document.getElementById('notification-message');
            
            messageElement.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('active');
            
            setTimeout(() => {
                notification.classList.remove('active');
            }, 3000);
        }
        
        function showSystemStatus() {
            const cachedPosition = getCachedPosition();
            const cachedText = cachedPosition ? 
                ` (Cachée: ${new Date(cachedPosition.timestamp).toLocaleTimeString()})` : 
                "";
            
            const status = `
                <div style="padding: 15px; min-width: 350px;">
                    <h3 style="color: #006400; margin-bottom: 15px;">
                        <i class="fas fa-heartbeat"></i> ÉTAT DU SYSTÈME GPS
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; font-size: 0.9rem;">
                        <div>
                            <strong>GPS:</strong> ${gpsWatchActive ? '🟢 ACTIF' : '🔴 INACTIF'}
                        </div>
                        <div>
                            <strong>Signal:</strong> ${GPS_CONFIG.gpsSignalQuality.toUpperCase()}
                        </div>
                        <div>
                            <strong>Suivi auto:</strong> ${autoTrackingEnabled ? '🟢 ON' : '🔴 OFF'}
                        </div>
                        <div>
                            <strong>Précision:</strong> ${lastPosition && lastPosition.accuracy ? lastPosition.accuracy.toFixed(0) + 'm' : 'N/A'}
                        </div>
                        <div>
                            <strong>Mode dégradé:</strong> ${GPS_CONFIG.fallbackMode ? '🟢 ACTIF' : '🔴 INACTIF'}
                        </div>
                        <div>
                            <strong>Erreurs:</strong> ${gpsErrorCount}
                        </div>
                        <div>
                            <strong>Force signal:</strong> ${gpsSignalStrength}%
                        </div>
                        <div>
                            <strong>Tentatives:</strong> ${gpsRetryCount}/${GPS_CONFIG.retryAttempts}
                        </div>
                    </div>
                    <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; font-size: 0.85rem;">
                        <div><strong>Dernière position:</strong> ${lastPosition ? lastPosition.timestamp.toLocaleTimeString() : 'Jamais'}${cachedText}</div>
                        <div><strong>Source:</strong> ${lastPosition ? lastPosition.source || 'GPS' : 'N/A'}</div>
                        <div><strong>Distance parcourue:</strong> ${totalDistance.toFixed(2)} km</div>
                        <div><strong>Points historiques:</strong> ${positionHistory.length}</div>
                        <div><strong>Positions sauvegardées:</strong> ${savedPositions.length}</div>
                        <div><strong>Précision min:</strong> ${lastValidAccuracy ? lastValidAccuracy.toFixed(0) + 'm' : 'N/A'}</div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 8px;">
                        <button onclick="startAutoGPS()" style="
                            flex: 1;
                            background: #0066FF;
                            color: white;
                            border: none;
                            padding: 8px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 0.8rem;
                        ">
                            <i class="fas fa-redo"></i> Redémarrer GPS
                        </button>
                        <button onclick="startFallbackMode()" style="
                            flex: 1;
                            background: #FF5722;
                            color: white;
                            border: none;
                            padding: 8px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 0.8rem;
                        ">
                            <i class="fas fa-wifi"></i> Mode dégradé
                        </button>
                    </div>
                </div>
            `;
            
            L.popup()
                .setLatLng(lastPosition ? [lastPosition.lat, lastPosition.lng] : map.getCenter())
                .setContent(status)
                .openOn(map);
        }
        
        function updateStatusDisplay() {
            setInterval(() => {
                if (lastPosition) {
                    const age = new Date() - lastPosition.timestamp;
                    const ageSeconds = Math.floor(age / 1000);
                    
                    if (ageSeconds > 30 && gpsWatchActive) {
                        document.getElementById('gps-status').textContent = "GPS: DERNIÈRE POSITION";
                    }
                    
                    if (ageSeconds > 60 && gpsWatchActive) {
                        console.log("⚠️ Pas de position depuis 1 minute, vérification GPS...");
                        navigator.geolocation.getCurrentPosition(
                            (pos) => {
                                console.log("✅ GPS toujours fonctionnel");
                                handlePositionSuccess(pos);
                            },
                            (err) => {
                                console.warn("⚠️ GPS test échoué:", err.message);
                                handleGPSError(err);
                            },
                            { timeout: 5000, maximumAge: 0 }
                        );
                    }
                }
            }, 5000);
        }
        
        function startInterfaceUpdates() {
            setInterval(() => {
                if (lastPosition) {
                    updateMarkerAnimation(lastPosition);
                    updateTotalDistance();
                }
            }, 1000);
        }
        
        function updateMarkerAnimation(position) {
            if (currentPositionMarker && position.speed > 0) {
                const markerElement = currentPositionMarker.getElement();
                if (markerElement) {
                    markerElement.classList.add('moving');
                }
            }
        }
        
        function updateTotalDistance() {
            if (positionHistory.length < 2) {
                totalDistance = 0;
                document.getElementById('metric-distance').textContent = "0.00";
                return;
            }
            
            let distance = 0;
            for (let i = 1; i < positionHistory.length; i++) {
                const prev = positionHistory[i-1];
                const curr = positionHistory[i];
                distance += calculateDistance(prev.lat, prev.lng, curr.lat, curr.lng);
            }
            
            totalDistance = distance;
            document.getElementById('metric-distance').textContent = distance.toFixed(2);
        }
        
        // =================== ÉVÉNEMENTS ===================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log("📄 Document chargé, initialisation en cours...");
            
            // Initialiser la carte
            initMilitaryMap();
            
            // Configurer la recherche
            setupSearch();
            
            // Configurer l'importation de fichiers
            setupFileUpload();
            
            // =================== MA POSITION ===================
            document.getElementById('find-my-position').addEventListener('click', findMyPosition);
            document.getElementById('save-position').addEventListener('click', saveCurrentPosition);
            document.getElementById('show-location-panel').addEventListener('click', showLocationPanel);
            document.getElementById('show-my-position').addEventListener('click', toggleMyPositionDisplay);
            document.getElementById('toggle-my-position').addEventListener('click', toggleMyPositionDisplay);
            document.getElementById('update-position').addEventListener('click', findMyPosition);
            document.getElementById('save-current-position').addEventListener('click', saveCurrentPosition);
            document.getElementById('share-my-position').addEventListener('click', function() {
                if (myPositionMarker) {
                    const latlng = myPositionMarker.getLatLng();
                    const message = `📍 MA POSITION: ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
                    const url = `https://wa.me/${GPS_CONFIG.whatsappPhone}?text=${encodeURIComponent(message)}`;
                    window.open(url, '_blank');
                    showNotification("Position partagée sur WhatsApp", "whatsapp");
                }
            });
            document.getElementById('close-location').addEventListener('click', function() {
                document.getElementById('location-panel').classList.remove('active');
            });
            
            // =================== GPS ET SUIVI ===================
            document.getElementById('auto-gps').addEventListener('click', startAutoGPS);
            document.getElementById('live-tracking').addEventListener('click', toggleAutoTracking);
            document.getElementById('tracking-toggle').addEventListener('click', toggleAutoTracking);
            
            // =================== TYPES DE CARTE ===================
            document.getElementById('map-type-standard').addEventListener('click', function() {
                changeMapLayer('standard');
            });
            document.getElementById('map-type-satellite').addEventListener('click', function() {
                changeMapLayer('satellite');
            });
            document.getElementById('map-type-topographic').addEventListener('click', function() {
                changeMapLayer('topographic');
            });
            document.getElementById('map-type-military').addEventListener('click', function() {
                changeMapLayer('military');
            });
            document.getElementById('map-type-terrain').addEventListener('click', function() {
                changeMapLayer('terrain');
            });
            document.getElementById('map-type-dark').addEventListener('click', function() {
                changeMapLayer('dark');
            });
            
            // Contrôles de couche
            document.getElementById('layer-standard').addEventListener('click', function() {
                changeMapLayer('standard');
            });
            document.getElementById('layer-satellite').addEventListener('click', function() {
                changeMapLayer('satellite');
            });
            document.getElementById('layer-topographic').addEventListener('click', function() {
                changeMapLayer('topographic');
            });
            document.getElementById('layer-military').addEventListener('click', function() {
                changeMapLayer('military');
            });
            document.getElementById('layer-terrain').addEventListener('click', function() {
                changeMapLayer('terrain');
            });
            document.getElementById('layer-dark').addEventListener('click', function() {
                changeMapLayer('dark');
            });
            
            // Contrôle carte militaire
            document.getElementById('toggle-military-map').addEventListener('click', function() {
                if (currentLayer === 'military') {
                    changeMapLayer('standard');
                } else {
                    changeMapLayer('military');
                }
            });
            
            // =================== PLEIN ÉCRAN ===================
            document.getElementById('fullscreen-map').addEventListener('click', toggleFullscreen);
            
            // =================== MODIFICATION DE CARTE ===================
            document.getElementById('draw-marker').addEventListener('click', function() {
                setDrawMode('marker');
                document.getElementById('draw-marker').classList.add('active');
            });
            document.getElementById('draw-polyline').addEventListener('click', function() {
                toggleDrawTools();
                document.getElementById('draw-polyline').classList.add('active');
            });
            document.getElementById('draw-polygon').addEventListener('click', function() {
                toggleDrawTools();
                document.getElementById('draw-polygon').classList.add('active');
            });
            document.getElementById('clear-drawings').addEventListener('click', clearAllDrawings);
            document.getElementById('toggle-draw').addEventListener('click', toggleDrawTools);
            
            // =================== OUTILS DE DESSIN SPÉCIFIQUES ===================
            document.getElementById('draw-tool-marker').addEventListener('click', function() {
                setDrawMode('marker');
                document.getElementById('draw-tool-marker').classList.add('active');
                setTimeout(() => {
                    document.getElementById('draw-tool-marker').classList.remove('active');
                }, 300);
            });
            document.getElementById('draw-tool-polyline').addEventListener('click', function() {
                map.removeControl(drawControl);
                drawControl.setDrawingOptions({ polyline: true });
                map.addControl(drawControl);
                document.getElementById('draw-tool-polyline').classList.add('active');
                setTimeout(() => {
                    document.getElementById('draw-tool-polyline').classList.remove('active');
                }, 300);
            });
            document.getElementById('draw-tool-polygon').addEventListener('click', function() {
                map.removeControl(drawControl);
                drawControl.setDrawingOptions({ polygon: true });
                map.addControl(drawControl);
                document.getElementById('draw-tool-polygon').classList.add('active');
                setTimeout(() => {
                    document.getElementById('draw-tool-polygon').classList.remove('active');
                }, 300);
            });
            document.getElementById('draw-tool-circle').addEventListener('click', function() {
                map.removeControl(drawControl);
                drawControl.setDrawingOptions({ circle: true });
                map.addControl(drawControl);
                document.getElementById('draw-tool-circle').classList.add('active');
                setTimeout(() => {
                    document.getElementById('draw-tool-circle').classList.remove('active');
                }, 300);
            });
            document.getElementById('draw-tool-rectangle').addEventListener('click', function() {
                map.removeControl(drawControl);
                drawControl.setDrawingOptions({ rectangle: true });
                map.addControl(drawControl);
                document.getElementById('draw-tool-rectangle').classList.add('active');
                setTimeout(() => {
                    document.getElementById('draw-tool-rectangle').classList.remove('active');
                }, 300);
            });
            
            // =================== CALCUL DE DISTANCE ===================
            document.getElementById('measure-distance').addEventListener('click', toggleMeasureMode);
            document.getElementById('generate-route').addEventListener('click', function() {
                toggleMeasureMode();
                setTimeout(() => {
                    document.getElementById('distance-panel').classList.add('active');
                }, 100);
            });
            document.getElementById('multi-point').addEventListener('click', toggleMultiPointsMode);
            document.getElementById('toggle-measure').addEventListener('click', toggleMeasureMode);
            document.getElementById('calculate-distance').addEventListener('click', calculateAndDisplayDistance);
            document.getElementById('generate-route-btn').addEventListener('click', generateRoute);
            document.getElementById('clear-points').addEventListener('click', function() {
                clearDistancePoints();
                clearMultiPoints();
            });
            document.getElementById('close-distance').addEventListener('click', function() {
                document.getElementById('distance-panel').classList.remove('active');
                isMeasuring = false;
                multiPointsMode = false;
                clearDistancePoints();
                clearMultiPoints();
                document.getElementById('multi-point').classList.remove('active');
                document.getElementById('toggle-measure').classList.remove('active');
            });
            
            // =================== RECHERCHE GÉOGRAPHIQUE ===================
            document.getElementById('search-location').addEventListener('click', function() {
                document.getElementById('location-search').focus();
                showNotification("Recherchez une localité dans la barre de recherche", "satellite");
            });
            document.getElementById('show-geography-panel').addEventListener('click', function() {
                if (geographyData) {
                    showGeographyPanel();
                } else {
                    // Si aucune donnée géographique, obtenir les infos pour le centre de la carte
                    const center = map.getCenter();
                    getGeographyInfo(center.lat, center.lng);
                }
            });
            document.getElementById('get-elevation').addEventListener('click', function() {
                const center = map.getCenter();
                getGeographyInfo(center.lat, center.lng);
            });
            document.getElementById('toggle-geography').addEventListener('click', function() {
                if (document.getElementById('geography-panel').classList.contains('active')) {
                    hideGeographyPanel();
                } else {
                    if (geographyData) {
                        showGeographyPanel();
                    } else {
                        const center = map.getCenter();
                        getGeographyInfo(center.lat, center.lng);
                    }
                }
            });
            document.getElementById('close-geography').addEventListener('click', hideGeographyPanel);
            document.getElementById('export-geography').addEventListener('click', exportGeographyData);
            document.getElementById('save-geography').addEventListener('click', saveGeographyData);
            
            // =================== IMPORT/EXPORT ===================
            document.getElementById('import-data').addEventListener('click', showImportModal);
            document.getElementById('export-kml').addEventListener('click', exportToKML);
            document.getElementById('export-data').addEventListener('click', exportDataToJSON);
            document.getElementById('export-measurements').addEventListener('click', exportMeasurements);
            document.getElementById('close-import').addEventListener('click', closeImportModal);
            document.getElementById('cancel-import').addEventListener('click', closeImportModal);
            document.getElementById('confirm-import').addEventListener('click', importDataFromFile);
            
            // =================== CONTRÔLES DE CARTE ===================
            document.getElementById('locate-me').addEventListener('click', centerOnPosition);
            document.getElementById('zoom-in').addEventListener('click', () => map.zoomIn());
            document.getElementById('zoom-out').addEventListener('click', () => map.zoomOut());
            document.getElementById('toggle-dashboard').addEventListener('click', toggleDashboard);
            document.getElementById('close-dashboard').addEventListener('click', toggleDashboard);
            document.getElementById('center-position').addEventListener('click', centerOnPosition);
            document.getElementById('quick-share').addEventListener('click', sendWhatsAppPosition);
            
            // =================== WHATSAPP ===================
            document.getElementById('whatsapp-share').addEventListener('click', sendWhatsAppPosition);
            document.getElementById('auto-whatsapp').addEventListener('click', toggleAutoWhatsApp);
            
            // =================== SYSTÈME ===================
            document.getElementById('system-status').addEventListener('click', showSystemStatus);
            document.getElementById('reset-system').addEventListener('click', function() {
                if (confirm("Voulez-vous vraiment réinitialiser le système ? Toutes les données seront perdues.")) {
                    localStorage.clear();
                    location.reload();
                }
            });
            
            // =================== MODE SÉLECTEUR ===================
            document.getElementById('mode-select').addEventListener('change', function() {
                const mode = this.value;
                
                switch(mode) {
                    case 'position':
                        findMyPosition();
                        showNotification("Mode position activé", "position");
                        break;
                    case 'gps':
                        startAutoGPS();
                        showNotification("Mode GPS activé", "gps");
                        break;
                    case 'tracking':
                        if (!autoTrackingEnabled) {
                            toggleAutoTracking();
                        }
                        showNotification("Mode suivi activé", "tracking");
                        break;
                    case 'search':
                        document.getElementById('location-search').focus();
                        showNotification("Mode recherche activé", "satellite");
                        break;
                    case 'measure':
                        toggleMeasureMode();
                        break;
                    case 'edit':
                        toggleDrawTools();
                        break;
                    case 'satellite':
                        changeMapLayer('satellite');
                        break;
                    case 'topographic':
                        changeMapLayer('topographic');
                        break;
                    case 'military':
                        changeMapLayer('military');
                        break;
                }
            });
            
            // =================== GESTION DU PLEIN ÉCRAN ===================
            document.addEventListener('fullscreenchange', function() {
                const mapContainer = document.getElementById('map-container');
                if (!document.fullscreenElement) {
                    mapContainer.classList.remove('fullscreen');
                    isFullscreen = false;
                    document.getElementById('fullscreen-map').classList.remove('active');
                }
            });
            
            document.addEventListener('webkitfullscreenchange', function() {
                const mapContainer = document.getElementById('map-container');
                if (!document.webkitFullscreenElement) {
                    mapContainer.classList.remove('fullscreen');
                    isFullscreen = false;
                    document.getElementById('fullscreen-map').classList.remove('active');
                }
            });
            
            document.addEventListener('msfullscreenchange', function() {
                const mapContainer = document.getElementById('map-container');
                if (!document.msFullscreenElement) {
                    mapContainer.classList.remove('fullscreen');
                    isFullscreen = false;
                    document.getElementById('fullscreen-map').classList.remove('active');
                }
            });
            
            // =================== FONCTION TOGGLE DASHBOARD ===================
            function toggleDashboard() {
                const dashboard = document.getElementById('gps-dashboard');
                const isVisible = dashboard.style.display !== 'none';
                
                if (isVisible) {
                    dashboard.style.display = 'none';
                    document.getElementById('toggle-dashboard').classList.remove('active');
                } else {
                    dashboard.style.display = 'block';
                    document.getElementById('toggle-dashboard').classList.add('active');
                }
            }
            
            // Initialisation terminée
            setTimeout(() => {
                showNotification("✅ Système de suivi GPS prêt. Cliquez sur 'Localiser Moi' pour trouver votre position.", "gps");
                console.log("✅ Initialisation terminée avec succès");
            }, 2000);
        });
        
        // Nettoyage à la fermeture
        window.addEventListener('beforeunload', function() {
            stopGPSWatch();
            console.log("🔄 Nettoyage avant fermeture");
        });
    </script>
</body>
</html>
